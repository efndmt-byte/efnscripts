<!doctype html>
<html lang="ru">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>EWL Order ‚Äî —Ç–µ–∫—Å—Ç–æ–≤–∞—è –ø–∞–º—è—Ç—å —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏–π</title>
<link rel="shortcut icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg'/>">
<script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/xlsx-populate/browser/xlsx-populate.min.js"></script>
<style>
  :root{--bg:#0b1020;--fg:#eaf0ff;--mut:#9fb2ff;--panel:#121a34;--border:#7aa2ff40;--accent:#1b2750}
  *{box-sizing:border-box}
  body{font-family:system-ui,Segoe UI,Roboto,Arial,sans-serif;background:var(--bg);color:var(--fg);margin:0;padding:24px}
  .card{background:var(--panel);border:1px solid var(--border);border-radius:16px;max-width:1360px;margin:0 auto;padding:18px}
  h1{margin:0 0 10px}

  label{display:block;margin-top:10px;color:var(--mut);font-weight:600}
  input,select,textarea,button{width:100%;border-radius:12px;border:1px solid #7aa2ff55;background:#0f1530;color:var(--fg);padding:10px;margin-top:6px}
  textarea{min-height:220px;white-space:pre;font-family:ui-monospace,Consolas,Menlo,monospace}

  .row{display:grid;grid-template-columns:1.2fr 0.8fr;gap:40px;align-items:start}
  .btn{cursor:pointer;font-weight:700;background:var(--accent);width:auto;display:inline-block;margin-right:8px}

  table{border-collapse:collapse;width:100%;margin-top:12px}
  th,td{border-bottom:1px solid #7aa2ff55;padding:8px;vertical-align:top}
  th{color:var(--mut)}

  tr.unmatched td{background:#51202a}
  tr.duplicate  td{background:#58461c}
  tr.unmatched.duplicate td{background:#60313a}

  .legend{display:flex;gap:10px;align-items:center;margin-top:6px;flex-wrap:wrap}
  .chip{display:inline-block;padding:4px 8px;border-radius:999px;border:1px solid #7aa2ff55}
  .chip.unm{background:#51202a}
  .chip.dupl{background:#58461c}

  .toolbar{display:flex;gap:10px;align-items:center;flex-wrap:wrap;margin:8px 0}

  /* –∫–æ–º–ø–∞–∫—Ç–Ω—ã–µ —á–µ–∫–±–æ–∫—Å—ã */
  input[type="checkbox"]{
    width:14px;
    height:14px;
    border-radius:4px;
    accent-color:#7aa2ff;
    vertical-align:middle;
  }
  label.inline{display:inline-flex;align-items:center;gap:6px;margin:0}

  #info{min-height:20px} .error{color:#ffa2a2} .ok{color:#b5ffbf}
  .modal{position:fixed;inset:0;background:#0008;display:none;align-items:center;justify-content:center;z-index:50}
  .modal>.box{background:#0f1530;border:1px solid #7aa2ff55;border-radius:14px;max-width:900px;width:90%;padding:12px}
  .modal input{width:100%}
  .results{max-height:420px;overflow:auto;margin-top:8px;border:1px solid #7aa2ff33;border-radius:10px}
  .resitem{padding:8px 10px;border-bottom:1px solid #7aa2ff22;cursor:pointer}
  .resitem:hover{background:#15204a}
  .selectWrap{position:relative}
  .selectWrap select{pointer-events:auto}
  .selectCover{position:absolute;inset:0;background:transparent;border:none;border-radius:12px;cursor:pointer}
.row{
  display:block;            /* –≤–º–µ—Å—Ç–æ grid: –≤—Å—ë –≤ –æ–¥–Ω—É –∫–æ–ª–æ–Ω–∫—É */
  grid-template-columns:none;
  gap:0;
}

#mapCard, .map-card, .right, #rightPane, .rightCol{
  position:static;
  top:auto;
  margin-top:16px;          /* —á—Ç–æ–±—ã –±—ã–ª –Ω–µ–±–æ–ª—å—à–æ–π –æ—Ç—Å—Ç—É–ø —Å–≤–µ—Ä—Ö—É */
}

/* —Ç–∞–±–ª–∏—Ü–∞ —Ä–µ–¥–∞–∫—Ç–æ—Ä–∞ –Ω–∞ –≤—Å—é —à–∏—Ä–∏–Ω—É, –±–µ–∑ –∏—Å–∫—É—Å—Å—Ç–≤–µ–Ω–Ω–æ–π –≤—ã—Å–æ—Ç—ã */
#mapTable, .map-table, #tbMap{
  max-height:none;
  overflow:visible;
}

</style>


</head>
<body>
  <div class="card">
    <h1>EWL Order</h1>

    <div class="row">
      <!-- –ª–µ–≤–∞—è: –≤–≤–æ–¥ –∑–∞–∫–∞–∑–∞ -->
      <div>
        <label>–®–∞–±–ª–æ–Ω (.xlsx)
          <input type="file" id="tmpl" accept=".xlsx,application/vnd.openxmlformats-officedocument.spreadsheetml.sheet">
        </label>
        <div class="inline-controls" style="margin-top:8px">
          <button class="btn" id="remember">–ó–∞–ø–æ–º–Ω–∏—Ç—å —à–∞–±–ª–æ–Ω</button>
          <button class="btn" id="clearStored">–ó–∞–±—ã—Ç—å</button>
          <span id="storedInfo" class="muted"></span>
        </div>

        <div class="inline-controls" style="margin-top:12px">
          <label style="flex:1">–î–∞—Ç–∞
            <input type="date" id="date">
          </label>
          <label style="flex:2">–†–µ—Å—Ç–æ—Ä–∞–Ω ‚Äî –ø–æ–∏—Å–∫
            <input id="citySearch" placeholder="–ü–æ–∏—Å–∫ –ø–∏—Ü—Ü–µ—Ä–∏–∏‚Ä¶">
          </label>
        </div>
        <label style="margin-top:8px">–†–µ—Å—Ç–æ—Ä–∞–Ω ‚Äî –≤—ã–±–æ—Ä
          <select id="city"></select>
        </label>

        <label style="margin-top:14px">–¢–µ–∫—Å—Ç –∑–∞–∫–∞–∑–∞
          <textarea id="order" placeholder="–í—Å—Ç–∞–≤—å—Ç–µ –∑–∞–∫–∞–∑ —Å—é–¥–∞..."></textarea>
        </label>

        <div class="toolbar">
          <button class="btn" id="preview">–ü—Ä–µ–¥–ø—Ä–æ—Å–º–æ—Ç—Ä</button>
          <button class="btn" id="download">–°–∫–∞—á–∞—Ç—å Excel</button>
          <label class="inline"><input type="checkbox" id="hideMatched"> –°–∫—Ä—ã–≤–∞—Ç—å —Å–æ–≤–ø–∞–≤—à–∏–µ</label>
          <label class="inline"><input type="checkbox" id="onlyProblems"> –¢–æ–ª—å–∫–æ –ø—Ä–æ–±–ª–µ–º–Ω—ã–µ</label>
          <input id="optionFilter" placeholder="–§–∏–ª—å—Ç—Ä –∫–∞—Ç–∞–ª–æ–≥–∞ —Å–ø—Ä–∞–≤–∞... (–ø–æ –ø–æ–¥—Å—Ç—Ä–æ–∫–µ)">
        </div>

        <div class="legend">
          <span class="chip unm">–Ω–µ –Ω–∞–π–¥–µ–Ω–æ</span>
          <span class="chip dupl">–ø–æ–≤—Ç–æ—Ä</span>
          <span id="statMatched" class="muted">–°–æ–≤–ø–∞–¥–µ–Ω–∏–π: 0 / 0</span>
          <span id="statTotal" class="muted">–ò—Ç–æ–≥–æ –∑–∞–∫–∞–∑–∞–Ω–æ –µ–¥–∏–Ω–∏—Ü: 0</span>
        </div>

        <div id="info" style="margin-top:6px"></div>

        <table>
          <thead><tr><th>–ù–∞–∏–º–µ–Ω–æ–≤–∞–Ω–∏–µ (–∏–∑ –∑–∞–∫–∞–∑–∞)</th><th>–°–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏–µ (–∫–∞—Ç–∞–ª–æ–≥)</th><th>–ö–æ–ª-–≤–æ</th></tr></thead>
          <tbody id="tbMap"></tbody>
        </table>
      </div>

      <!-- –ø—Ä–∞–≤–∞—è: —Ä–µ–¥–∞–∫—Ç–æ—Ä –ø–∞–º—è—Ç–∏ -->
      <div class="rightCol">
        <h3 style="margin:0 0 8px">–†–µ–¥–∞–∫—Ç–æ—Ä —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏–π</h3>
        <div class="inline-controls">
          <button class="btn" id="exportMap">–≠–∫—Å–ø–æ—Ä—Ç JSON</button>
          <button class="btn" id="importMap">–ò–º–ø–æ—Ä—Ç JSON</button>
          <input id="importMapFile" type="file" accept="application/json" style="display:none">
          <button class="btn" id="clearMap">–û—á–∏—Å—Ç–∏—Ç—å</button>
        </div>
        <table>
          <thead><tr><th>–ö–ª—é—á (–∏–∑ –∑–∞–∫–∞–∑–∞)</th><th>–ó–Ω–∞—á–µ–Ω–∏–µ (–∫–∞—Ç–∞–ª–æ–≥ / #ROW:n)</th><th></th></tr></thead>
          <tbody id="mapBody"></tbody>
        </table>
      </div>
    </div>
  </div>

  <!-- –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ-–ª—É–ø–∞ –ø–æ –∫–∞—Ç–∞–ª–æ–≥—É -->
  <div class="modal" id="picker">
    <div class="box">
      <div style="display:flex;gap:8px;align-items:center">
        <input id="pickerQuery" placeholder="–ò—â–∏—Ç–µ –ø–æ –ø–æ–¥—Å—Ç—Ä–æ–∫–µ‚Ä¶">
        <button class="btn" id="pickerClose" style="margin:0">–ó–∞–∫—Ä—ã—Ç—å</button>
      </div>
      <div class="results" id="pickerResults"></div>
    </div>
  </div>

<script>
/* ====================== –ë–ê–ó–û–í–´–ï –£–¢–ò–õ–´ ====================== */
const LS_KEY='ewl_map_v2';

function norm(s){
  return String(s||'')
    .toLowerCase()
    .replace(/[—ë]/g,'–µ')
    .replace(/["'`]/g,'')
    .replace(/\s+/g,' ')
    .trim();
}

// –ø–∞–º—è—Ç—å —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏–π (localStorage)
function loadMemory(){
  try{
    const raw=localStorage.getItem(LS_KEY);
    if(!raw) return {version:2,map:{}};
    const data=JSON.parse(raw);
    if(!data.map) return {version:2,map:{}};
    return {version:2,map:data.map};
  }catch{ return {version:2,map:{}}; }
}
function saveMemory(obj){ localStorage.setItem(LS_KEY, JSON.stringify(obj)); }
function rememberMatch(srcText, templText){
  const mem=loadMemory();
  const key=norm(srcText), val=norm(templText);
  mem.map[key]=val; saveMemory(mem);
}
function forgetMatch(srcText){
  const mem=loadMemory(); const key=norm(srcText);
  delete mem.map[key]; saveMemory(mem);
}

// –ø–∞—Ä—Å–∏–Ω–≥ –∑–∞–∫–∞–∑–∞: –±–µ—Ä—ë–º —Å—Ç—Ä–æ–∫–∏ –ø–æ—Å–ª–µ "–ù–∞–∏–º–µ–Ω–æ–≤–∞–Ω–∏–µ", qty = –ø–æ—Å–ª–µ–¥–Ω–µ–µ —á–∏—Å–ª–æ/—Ü–µ–ª–æ–µ
function parseOrder(text){
  const lines = String(text||'').split(/\r?\n/);
  let start = 0;
  for(let i=0;i<lines.length;i++){
    if (/–Ω–∞–∏–º–µ–Ω–æ–≤–∞–Ω/i.test(lines[i])) { start = i+1; break; }
  }
  const out = [];
  for(let i=start;i<lines.length;i++){
    const line = lines[i].trim();
    if(!line) continue;
    const m = line.match(/(.+?)\s+(-?\d+(?:[.,]\d+)?)\s*$/); // –∏–º—è ... qty
    if(m){
      const name = m[1].trim();
      const qty  = m[2].replace(',', '.');
      out.push([name, parseFloat(qty)]);
    } else {
      // –µ—Å–ª–∏ –Ω–µ—Ç –∫–æ–ª–∏—á–µ—Å—Ç–≤–∞, –∏–≥–Ω–æ—Ä–∏–º —Å—Ç—Ä–æ–∫—É
    }
  }
  return out;
}

function setInfo(msg, isErr=false){
  const box=document.getElementById('info');
  if(!box) return;
  box.innerHTML = isErr ? `<span class="error">${msg}</span>` : `<span class="ok">${msg}</span>`;
}

/* ====================== –û–¢ IndexedDB –ò –î–û –ö–û–ù–¶–ê ====================== */

// ================= IndexedDB –∏ –∫—ç—à =================
const DB = 'ewl_order_prod_db',
      STORE = 'kv',
      KEY_BUF = 'template_buf',
      KEY_NAME = 'template_name',
      KEY_CITIES = 'cities_cache_v1';

function idb(){
  return new Promise((res,rej)=>{
    const r = indexedDB.open(DB,1);
    r.onupgradeneeded = () => r.result.createObjectStore(STORE);
    r.onsuccess = () => res(r.result);
    r.onerror = () => rej(r.error);
  });
}
async function getKV(k){
  const d = await idb();
  return new Promise((res,rej)=>{
    const tx=d.transaction(STORE,'readonly'), st=tx.objectStore(STORE), r=st.get(k);
    r.onsuccess=()=>res(r.result||null); r.onerror=()=>rej(r.error);
  });
}
async function setKV(k,v){
  const d = await idb();
  return new Promise((res,rej)=>{
    const tx=d.transaction(STORE,'readwrite'), st=tx.objectStore(STORE), r=st.put(v,k);
    r.onsuccess=()=>res(); r.onerror=()=>rej(r.error);
  });
}
async function delKV(k){
  const d = await idb();
  return new Promise((res,rej)=>{
    const tx=d.transaction(STORE,'readwrite'), st=tx.objectStore(STORE), r=st.delete(k);
    r.onsuccess=()=>res(); r.onerror=()=>rej(r.error);
  });
}

// ---- –°–ø—Ä–∞–≤–æ—á–Ω–∏–∫ –ø–∏—Ü—Ü–µ—Ä–∏–π ----
function populateCities(cities){
  const sel = document.getElementById('city');
  if (!sel) return;
  sel.innerHTML = '';
  for (const {code,name} of (cities||[])){
    const o = document.createElement('option');
    o.value = name;
    o.textContent = name;
    o.dataset.code = code;
    sel.appendChild(o);
  }
}
async function getCachedCities(){ try { return await getKV(KEY_CITIES); } catch { return null; } }
async function setCachedCities(cities){ try { await setKV(KEY_CITIES, cities); } catch {} }

// –ì–ª–æ–±–∞–ª—å–Ω—ã–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ —Ç–∞–±–ª–∏—Ü—ã
let catalog=[];       // [{r,text,norm}]
let assignments=[];   // [{src,qty,destR}]
let lastRows=[];      // [[src,qty]...]
let rowMetas=[];      // [{tr,sel,isDup}...]

// ================= –ê–≤—Ç–æ–∑–∞–≥—Ä—É–∑–∫–∞ –ø—Ä–∏ —Å—Ç–∞—Ä—Ç–µ =================
(async()=>{
  try {
    // —à–∞–±–ª–æ–Ω
    const buf  = await getKV(KEY_BUF);
    const name = await getKV(KEY_NAME);
    if(buf){
      window.templateBuf = buf;
      window.templateName = name || '(–∑–∞–ø–æ–º–Ω–µ–Ω–Ω—ã–π)';
      const storedInfo = document.getElementById('storedInfo');
      if(storedInfo) storedInfo.textContent = '–®–∞–±–ª–æ–Ω: ' + window.templateName;
    }

    // –ø–∏—Ü—Ü–µ—Ä–∏–∏
    const cachedCities = await getCachedCities();
    if (cachedCities) {
      populateCities(cachedCities);
      window.citiesArray = cachedCities;
    }

    renderMapEditor();
  } catch(e){
    setInfo('IndexedDB –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω (—à–∞–±–ª–æ–Ω/—Å–ø—Ä–∞–≤–æ—á–Ω–∏–∫ –Ω–µ –±—É–¥—É—Ç –∑–∞–ø–æ–º–∏–Ω–∞—Ç—å—Å—è)',true);
  }
})();

// ================= –ö–Ω–æ–ø–∫–∞ "–ó–∞–ø–æ–º–Ω–∏—Ç—å —à–∞–±–ª–æ–Ω" =================
document.getElementById('remember').onclick = async()=>{
  const f = document.getElementById('tmpl').files[0];
  if(!f){ setInfo('–í—ã–±–µ—Ä–∏—Ç–µ .xlsx',true); return; }
  const buf = await f.arrayBuffer();
  await setKV(KEY_BUF, buf);
  await setKV(KEY_NAME, f.name);
  window.templateBuf = buf;
  window.templateName = f.name;
  const storedInfo = document.getElementById('storedInfo');
  if(storedInfo) storedInfo.textContent = '–®–∞–±–ª–æ–Ω: '+f.name;
  setInfo('–®–∞–±–ª–æ–Ω –∑–∞–ø–æ–º–Ω–µ–Ω');

  // ‚ö° –µ—Å–ª–∏ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ –≤—ã—Ç–∞—â–∏–ª–∏ —Å–ø–∏—Å–æ–∫ –≥–æ—Ä–æ–¥–æ–≤, —Å–æ—Ö—Ä–∞–Ω–∏–º –∏ –µ–≥–æ
  if (window.citiesArray && Array.isArray(window.citiesArray)) {
    await setCachedCities(window.citiesArray);
    populateCities(window.citiesArray);
  }
};

document.getElementById('clearStored').onclick=async()=>{
  await delKV(KEY_BUF); await delKV(KEY_NAME); window.templateBuf=null; window.templateName=null;
  const storedInfo = document.getElementById('storedInfo'); if(storedInfo) storedInfo.textContent='';
  setInfo('–®–∞–±–ª–æ–Ω –∑–∞–±—ã–ª–∏');
};

// ------------------- —á—Ç–µ–Ω–∏–µ —à–∞–±–ª–æ–Ω–∞ -------------------
async function readCatalogAndL1(){
  const f=document.getElementById('tmpl').files[0];
  const buf = f?await f.arrayBuffer():(window.templateBuf||await getKV(KEY_BUF));
  if(!buf) throw new Error('–ù–µ—Ç —à–∞–±–ª–æ–Ω–∞');
  const wb = XLSX.read(buf,{type:'array',cellText:true,cellDates:true,cellNF:true});

  // Catalog –∏–∑ Order!D14:D...
  const order = wb.Sheets['Order']; if(!order) throw new Error('–ù–µ—Ç –ª–∏—Å—Ç–∞ Order');
  const ref = order['!ref'] || 'A1'; const range=XLSX.utils.decode_range(ref);
  const list=[];
  for(let r=14;r<=range.e.r+1;r++){
    const addr=XLSX.utils.encode_cell({c:3,r:r-1}); // D
    const cell=order[addr];
    if(!cell) continue;
    const text=(cell.w!=null?String(cell.w):(cell.v!=null?String(cell.v):'')).trim();
    if(text) list.push({r,text,norm:norm(text)});
  }
  catalog=list;

  // –ü–∏—Ü—Ü–µ—Ä–∏–∏ –∏–∑ L1 (–µ—Å–ª–∏ –µ—Å—Ç—å)
  const l1 = wb.Sheets['L1'];
  if(l1){
    const rows=XLSX.utils.sheet_to_json(l1,{header:1,defval:''});
    const arr=[];
    for(let i=1;i<rows.length;i++){
      const code=String(rows[i][1]??'').trim();
      const city=String(rows[i][2]??'').trim();
      if(city) arr.push({code,name:city});
    }
    if(arr.length){
      window.citiesArray = arr;
      populateCities(arr);
      await setCachedCities(arr);
    }
  }
  return buf;
}

function buildTemplateIndex(){
  const idx=new Map(); for(const c of catalog){ idx.set(c.norm, c.r); } return idx;
}

// –∞–≤—Ç–æ-–ø–æ–∏—Å–∫ –µ—Å–ª–∏ –ø–∞–º—è—Ç–∏ –Ω–µ—Ç
function autoMatchByIncludes(userTextNorm){
  let hit = catalog.find(c=>c.norm.includes(userTextNorm)||userTextNorm.includes(c.norm));
  if(hit) return hit.r;
  const terms=userTextNorm.split(' ').filter(Boolean);
  hit = catalog.find(c=> terms.every(t=>c.norm.includes(t)) );
  return hit?hit.r:null;
}

function updateStats(){
  const total=lastRows.reduce((s,[,q])=>s+Number(q||0),0);
  const matched=assignments.reduce((s,a)=>s+(a.destR!=null?1:0),0);
  const sm=document.getElementById('statMatched');
  const st=document.getElementById('statTotal');
  if(sm) sm.textContent=`–°–æ–≤–ø–∞–¥–µ–Ω–∏–π: ${matched} / ${lastRows.length}`;
  if(st) st.textContent=`–ò—Ç–æ–≥–æ –∑–∞–∫–∞–∑–∞–Ω–æ –µ–¥–∏–Ω–∏—Ü: ${total}`;
}

// —Ñ–∏–ª—å—Ç—Ä—ã + –æ–≤–µ—Ä–ª–µ–π
const picker=document.getElementById('picker');
const pickerQuery=document.getElementById('pickerQuery');
const pickerResults=document.getElementById('pickerResults');
const pickerClose=document.getElementById('pickerClose');

// üîß –§–∏–ª—å—Ç—Ä–∞—Ü–∏—è —Å–ø–∏—Å–∫–∞ –ø—Ä–∏ –Ω–∞–±–æ—Ä–µ –≤ –ø–æ–∏—Å–∫–æ–≤–æ–π —Å—Ç—Ä–æ–∫–µ
pickerQuery.addEventListener('input', (e) => {
  renderPickerResults(e.target.value);
});

// Enter ‚Äî –≤—ã–±—Ä–∞—Ç—å –ø–µ—Ä–≤—ã–π
pickerQuery.addEventListener('keydown', (e) => {
  if (e.key === 'Enter') {
    const first = pickerResults.querySelector('.resitem[data-r]');
    if (first) { first.click(); e.preventDefault(); }
  }
});

let activePickerSel=null;
function openPicker(forSelect){ activePickerSel=forSelect; picker.style.display='flex'; pickerQuery.value=''; renderPickerResults(''); pickerQuery.focus(); }
function closePicker(){ picker.style.display='none'; activePickerSel=null; }
pickerClose.onclick=closePicker; picker.addEventListener('click',e=>{ if(e.target===picker) closePicker(); });
window.addEventListener('keydown',e=>{ if(e.key==='Escape') closePicker(); });

function renderPickerResults(q){
  const terms=norm(q).split(' ').filter(Boolean);
  const filtered = catalog.filter(c=> terms.every(t=>c.norm.includes(t)) );
  pickerResults.innerHTML = filtered.map(c=>`<div class="resitem" data-r="${c.r}">${c.text.replace(/</g,'&lt;').replace(/>/g,'&gt;')}</div>`).join('') || '<div class="resitem">–ù–∏—á–µ–≥–æ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ</div>';
  for(const div of pickerResults.querySelectorAll('.resitem[data-r]')){
    div.onclick=()=>{ if(activePickerSel){ activePickerSel.value=div.dataset.r; activePickerSel.dispatchEvent(new Event('change')); } closePicker(); };
  }
}

const optionFilter=document.getElementById('optionFilter');
optionFilter.addEventListener('input', ()=>{
  const f=norm(optionFilter.value);
  for(const m of rowMetas) rebuildOptions(m.sel, f);
});

function rebuildOptions(sel, filter){
  const keep=sel.value;
  sel.innerHTML = '<option value="">‚Äî –≤—ã–±–µ—Ä–∏—Ç–µ ‚Äî</option>' + catalog.filter(c=>!filter||c.norm.includes(filter)).map(c=>`<option value="${c.r}">${c.text.replace(/</g,'&lt;').replace(/>/g,'&gt;')}</option>`).join('');
  if(keep && [...sel.options].some(o=>o.value===String(keep))) sel.value=String(keep);
}

function applyRowFlags(tr, unmatched, dup){ tr.classList.toggle('unmatched', !!unmatched); tr.classList.toggle('duplicate', !!dup); }
function applyFilters(){
  const hide = document.getElementById('hideMatched').checked, prob = document.getElementById('onlyProblems').checked;
  for(const m of rowMetas){
    const r = m.sel.value?parseInt(m.sel.value,10):null;
    const unmatched = (r==null), dup = m.isDup;
    let show = true;
    if(hide && !unmatched) show=false;
    if(prob && !(unmatched||dup)) show=false;
    m.tr.style.display = show ? '' : 'none';
  }
}
document.getElementById('hideMatched').addEventListener('change', applyFilters);
document.getElementById('onlyProblems').addEventListener('change', applyFilters);

// –ø–æ—Å—Ç—Ä–æ–π–∫–∞ —Ç–∞–±–ª–∏—Ü—ã
function buildTable(rows){
  const tbMap=document.getElementById('tbMap'); tbMap.innerHTML=''; assignments=[]; lastRows=rows; rowMetas=[];
  const counts=new Map(); for(const [s] of rows){ const k=norm(s); counts.set(k,(counts.get(k)||0)+1); }

  const mem = loadMemory();
  const templateIdx = buildTemplateIndex(); // norm -> r

  for(const [src,qty] of rows){
    const tr=document.createElement('tr');
    const wrap=document.createElement('div'); wrap.className='selectWrap';
    const sel=document.createElement('select'); sel.innerHTML='';
    const cover=document.createElement('button'); cover.type='button'; cover.className='selectCover'; cover.title='–ü–æ–∏—Å–∫';
    wrap.appendChild(sel); wrap.appendChild(cover);
    tr.innerHTML=`<td class="warn"></td><td></td><td>${qty}</td>`;
    tr.children[0].textContent=src;
    tr.children[1].appendChild(wrap);
    tbMap.appendChild(tr);
    rebuildOptions(sel,'');

    cover.addEventListener('click', ()=> openPicker(sel) );

    const key=norm(src);
    let preR=null;
    const savedTemplNorm = mem.map[key];
    if(savedTemplNorm){
      if(savedTemplNorm.startsWith('#ROW:')){
        const row = parseInt(savedTemplNorm.slice(5),10);
        if(Number.isFinite(row)) preR=row;
      }else{
        const row = templateIdx.get(savedTemplNorm);
        if(row) preR=row;
      }
    }else{
      preR = autoMatchByIncludes(key);
    }
    if(preR) sel.value=String(preR);

    const isDup=(counts.get(key)||0)>1;
    function upd(){
      const r = sel.value?parseInt(sel.value,10):null;
      const idx=assignments.findIndex(a=>a.src===src);
      if(idx>=0) assignments[idx]={src,qty,destR:r}; else assignments.push({src,qty,destR:r});
      if(r!=null){
        const chosen = catalog.find(c=>c.r===r);
        if(chosen) rememberMatch(src, chosen.text);
      }else{
        forgetMatch(src);
      }
      applyRowFlags(tr, r==null, isDup); applyFilters(); updateStats();
    }
    sel.addEventListener('change',upd);
    rowMetas.push({tr,sel,isDup});
    applyRowFlags(tr, preR==null, isDup); upd();
  }
}

// –ø—Ä–µ–¥–ø—Ä–æ—Å–º–æ—Ç—Ä
document.getElementById('preview').onclick = async ()=>{
  try{
    setInfo('');
    await readCatalogAndL1();
    const rows=parseOrder(document.getElementById('order').value);
    buildTable(rows);
    setInfo(`–ö–∞—Ç–∞–ª–æ–≥ –∑–∞–≥—Ä—É–∂–µ–Ω: ${catalog.length} –ø–æ–∑–∏—Ü–∏–π.`);
  }catch(e){ setInfo(e.message,true); }
};

// —Å–∫–∞—á–∏–≤–∞–Ω–∏–µ Excel
function safeFilename(s){ return s.replace(/[\\/:*?"<>|]+/g,' ').replace(/\s{2,}/g,' ').trim(); }
function buildFilename(){ 
  const city = (document.getElementById('city').value) || (document.getElementById('city').options[0]?.value||'EWL_Order');
  const dt = document.getElementById('date').value;
  let ddmm = '–¥–∞—Ç–∞'; if(dt){ const [yyyy,mm,dd]=dt.split('-'); ddmm=`${dd}.${mm}.${yyyy}`; }
  return `${city} ${ddmm}.xlsx`;
}
document.getElementById('download').onclick = async ()=>{
  try{
    setInfo('');
    const buf = await readCatalogAndL1();
    const wb = await XlsxPopulate.fromDataAsync(buf);
    const order=wb.sheet('Order'); const l1=wb.sheet('L1');
    // D2 ‚Äî –∫–æ–¥ + –≥–æ—Ä–æ–¥
    const city = (document.getElementById('city').value) || (document.getElementById('city').options[0]?.value||'');
    let code=''; if(l1){ const end=l1.usedRange().endCell().rowNumber(); const nrm=s=>String(s??'').toLowerCase().trim();
      for(let r=2;r<=end;r++){ const b=l1.cell(r,2).value(), c=l1.cell(r,3).value(); if(nrm(c)===nrm(city)){ code=(typeof b==='number')?String(Math.trunc(b)):String(b??''); break; } } }
    const merged = (city==='–¢–æ–ª—å—è—Ç—Ç–∏-5') ? '1369-–¢–æ–ª—å—è—Ç—Ç–∏-5' : (code ? `${code} - ${city}` : city);
    order.cell('D2').value(merged);
    // D8 ‚Äî –¥–∞—Ç–∞
    const dt=document.getElementById('date').value; if(dt){ const [yy,mm,dd]=dt.split('-'); order.cell('D8').value(`${dd}.${mm}.${yy}`); }
    // F ‚Äî –æ—á–∏—Å—Ç–∏—Ç—å –∏ –∑–∞–ø–∏—Å–∞—Ç—å –∫–æ–ª–∏—á–µ—Å—Ç–≤–∞
    const endRow=order.usedRange().endCell().rowNumber(); for(let r=14;r<=endRow;r++) order.cell(r,6).value(null);
    let written=0; for(const a of assignments){ if(a.destR!=null && a.destR>=14 && a.destR<=endRow){ order.cell(a.destR,6).value(a.qty); written++; } }
    const out=await wb.outputAsync(); const blob=new Blob([out],{type:'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet'});
    const a=document.createElement('a'); a.href=URL.createObjectURL(blob); a.download=safeFilename(buildFilename()); a.click(); setTimeout(()=>URL.revokeObjectURL(a.href),1500);
    setInfo(`–°–∫–∞—á–∞–Ω–æ. –ó–∞–ø–∏—Å–∞–Ω–æ –ø–æ–∑–∏—Ü–∏–π: ${written}`);
  }catch(e){ setInfo(e.message,true); }
};

// –ø–æ–∏—Å–∫ –ø–∏—Ü—Ü–µ—Ä–∏–∏
const citySearch=document.getElementById('citySearch');
const citySel=document.getElementById('city');
citySearch.addEventListener('input',()=>{
  const q=norm(citySearch.value);
  for(const opt of citySel.options){
    const show=!q||norm(opt.textContent).includes(q);
    opt.style.display=show?'':'none';
  }
});

// ------------------- —Ä–µ–¥–∞–∫—Ç–æ—Ä –ø–∞–º—è—Ç–∏ -------------------
const mapBody=document.getElementById('mapBody');
function renderMapEditor(){
  const mem=loadMemory();
  mapBody.innerHTML='';
  for(const [k,v] of Object.entries(mem.map)){
    let shownText=v;
    if(!v.startsWith('#ROW:')){
      for(const c of catalog){ if(c.norm===v){ shownText=c.text; break; } }
    }
    const tr=document.createElement('tr');
    tr.innerHTML = `<td contenteditable="true" class="key">${k}</td>
                    <td contenteditable="true" class="val">${shownText}</td>
                    <td><button class="btn" style="padding:6px 10px">‚úï</button></td>`;
    const del=tr.querySelector('button');
    del.onclick=()=>{ const mem=loadMemory(); delete mem.map[k]; saveMemory(mem); renderMapEditor(); };
    tr.querySelector('.key').onblur=()=>{
      const newK=norm(tr.querySelector('.key').textContent||'');
      const mem=loadMemory(); const cur=mem.map[k]; delete mem.map[k]; if(newK) mem.map[newK]=cur; saveMemory(mem); renderMapEditor();
    };
    tr.querySelector('.val').onblur=()=>{
      const newVal=norm(tr.querySelector('.val').textContent||'');
      const mem=loadMemory(); mem.map[k]=newVal; saveMemory(mem); renderMapEditor();
    };
    mapBody.appendChild(tr);
  }
}
document.getElementById('exportMap').onclick=()=>{
  const mem=loadMemory();
  const blob=new Blob([JSON.stringify(mem,null,2)],{type:'application/json'});
  const a=document.createElement('a'); a.href=URL.createObjectURL(blob); a.download='ewl_mapping_text.json'; a.click(); setTimeout(()=>URL.revokeObjectURL(a.href),1200);
};
document.getElementById('importMap').onclick=()=> document.getElementById('importMapFile').click();
document.getElementById('importMapFile').onchange=async(e)=>{
  const f=e.target.files[0]; if(!f) return;
  try{ const txt=await f.text(); const data=JSON.parse(txt); if(!data.map) throw new Error('–ù–µ—Ç –ø–æ–ª—è map');
    localStorage.setItem(LS_KEY, JSON.stringify({version:2,map:data.map})); renderMapEditor(); setInfo('–ò–º–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞–Ω–æ'); }catch{ setInfo('–û—à–∏–±–∫–∞ –∏–º–ø–æ—Ä—Ç–∞ JSON', true); }
};
document.getElementById('clearMap').onclick=async()=>{ if(confirm('–û—á–∏—Å—Ç–∏—Ç—å –ø–∞–º—è—Ç—å —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏–π?')){ localStorage.removeItem(LS_KEY); renderMapEditor(); } };
</script>
</body>
</html>


