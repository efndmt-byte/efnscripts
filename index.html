<!doctype html>
<html lang="ru">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>EWL Order</title>
<script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/xlsx-populate/browser/xlsx-populate.min.js"></script>
<style>
  :root{--bg:#0b1020;--fg:#eaf0ff;--mut:#9fb2ff;--panel:#121a34;--border:#7aa2ff40;--accent:#1b2750}
  *{box-sizing:border-box}
  body{font-family:system-ui,Segoe UI,Roboto,Arial,sans-serif;background:var(--bg);color:var(--fg);margin:0;padding:24px}
  .card{background:var(--panel);border:1px solid var(--border);border-radius:16px;max-width:1360px;margin:0 auto;padding:18px}
  h1{margin:0 0 10px}
  label{display:block;margin-top:10px;color:var(--mut);font-weight:600}
  input,select,textarea,button{width:100%;border-radius:12px;border:1px solid #7aa2ff55;background:#0f1530;color:var(--fg);padding:10px;margin-top:6px}
  textarea{min-height:220px;white-space:pre;font-family:ui-monospace,Consolas,Menlo,monospace}
  .row{display:grid;grid-template-columns:1.2fr 0.8fr;gap:40px;align-items:start}
  .btn{cursor:pointer;font-weight:700;background:var(--accent);width:auto;display:inline-block;margin-right:8px}
  table{border-collapse:collapse;width:100%;margin-top:12px}
  th,td{border-bottom:1px solid #7aa2ff55;padding:8px;vertical-align:top} th{color:var(--mut)}
  tr.unmatched td{background:#51202a} tr.duplicate td{background:#58461c} tr.unmatched.duplicate td{background:#60313a}
  .legend{display:flex;gap:10px;align-items:center;margin-top:6px;flex-wrap:wrap}
  .chip{display:inline-block;padding:4px 8px;border-radius:999px;border:1px solid #7aa2ff55}
  .chip.unm{background:#51202a} .chip.dupl{background:#58461c}
  .toolbar{display:flex;gap:10px;align-items:center;flex-wrap:wrap;margin:8px 0}
  #info{min-height:20px} .error{color:#ffa2a2}
  /* advanced picker modal */
  .modal{position:fixed;inset:0;background:#0008;display:none;align-items:center;justify-content:center;z-index:50}
  .modal>.box{background:#0f1530;border:1px solid #7aa2ff55;border-radius:14px;max-width:900px;width:90%;padding:12px}
  .modal input{width:100%}
  .results{max-height:420px;overflow:auto;margin-top:8px;border:1px solid #7aa2ff33;border-radius:10px}
  .resitem{padding:8px 10px;border-bottom:1px solid #7aa2ff22;cursor:pointer}
  .resitem:hover{background:#15204a}
  .row-actions{display:flex;gap:8px;align-items:center}
  .mini{padding:6px 10px;font-size:12px}
  .selectWrap{position:relative}
  .selectWrap select{pointer-events:none}
  .selectCover{position:absolute;inset:0;background:transparent;border-radius:12px;border:none;cursor:pointer}
  /* map editor table */
  #mapTable td{border-bottom:1px dashed #7aa2ff33}
</style>
</head>
<body>
<div class="card">
  <h1>EWL Order</h1>

  <label>Шаблон Excel (.xlsx)</label>
  <input type="file" id="tmpl" accept=".xlsx">
  <div>
    <button class="btn" id="remember">Запомнить шаблон</button>
    <button class="btn" id="clearStored">Забыть шаблон</button>
    <span id="storedInfo" style="color:#9fb2ff"></span>
  </div>

  <div class="row" style="margin-top:10px">
    <div>
      <label>Текст заказа</label>
      <textarea id="order" placeholder="После «Наименование» — по строке на позицию, число в конце — количество."></textarea>
      <button class="btn" id="clearOrder">Очистить текст</button>
    </div>
    <div>
      <label>Ресторан</label>
      <input id="citySearch" type="text" placeholder="Поиск пиццерии...">
      <select id="city" size="8" style="height:220px"></select>
      <label>Дата</label>
      <input type="date" id="date">
      <div style="margin-top:8px">
        <button class="btn" id="preview">Предпросмотр</button>
        <button class="btn" id="download">Скачать Excel</button>
      </div>
      <div style="margin-top:8px;color:#cde3ff">
        <div id="statMatched">Совпадений: 0 / 0</div>
        <div id="statTotal">Итого заказано единиц: 0</div>
        <div id="info"></div>
        <div class="legend"><span class="chip unm">нет совпадения</span><span class="chip dupl">дубликат</span></div>
      </div>
    </div>
  </div>

  <div class="toolbar">
    <label style="display:flex;gap:8px"><input type="checkbox" id="hideMatched">Скрывать совпавшие</label>
    <label style="display:flex;gap:8px"><input type="checkbox" id="onlyProblems">Только проблемные</label>
    <input type="text" id="optionFilter" placeholder="Поиск в Order!D (по подстроке)">
  </div>

  <label>Соответствия</label>
  <table>
    <thead><tr><th>Из заказа</th><th>Order!D</th><th>Qty</th></tr></thead>
    <tbody id="tbMap"></tbody>
  </table>

  <details style="margin-top:16px">
    <summary>Редактор соответствий (память)</summary>
    <div class="toolbar">
      <button class="btn mini" id="exportMap">Экспорт JSON</button>
      <input type="file" id="importMapFile" accept=".json" style="display:none">
      <button class="btn mini" id="importMap">Импорт JSON</button>
      <button class="btn mini" id="clearMap">Очистить память соответствий</button>
    </div>
    <table id="mapTable">
      <thead><tr><th>Ключ (normalize из заказа)</th><th>Строка Order!D</th><th></th></tr></thead>
      <tbody id="mapBody"></tbody>
    </table>
  </details>
</div>

<!-- Advanced picker modal -->
<div class="modal" id="picker">
  <div class="box">
    <input type="text" id="pickerQuery" placeholder="Ищите по подстроке, можно несколько слов через пробел">
    <div class="results" id="pickerResults"></div>
    <div style="display:flex;justify-content:flex-end;margin-top:8px">
      <button class="btn mini" id="pickerClose">Закрыть (Esc)</button>
    </div>
  </div>
</div>

<script>
// Simple error display
const infoEl = document.getElementById('info');
function setInfo(msg,isErr=false){ infoEl.textContent = msg||''; infoEl.classList.toggle('error', !!isErr); }
window.addEventListener('error', e=>setInfo(e.message,true));
window.addEventListener('unhandledrejection', e=>setInfo(String(e.reason?.message||e.reason),true));

// IndexedDB tiny KV
const DB='ewl_order_prod_db', STORE='kv';
function idb(){ return new Promise((res,rej)=>{ const r=indexedDB.open(DB,1); r.onupgradeneeded=()=>r.result.createObjectStore(STORE); r.onsuccess=()=>res(r.result); r.onerror=()=>rej(r.error); }); }
async function getKV(k){ const d=await idb(); return new Promise((res,rej)=>{ const tx=d.transaction(STORE,'readonly'); const st=tx.objectStore(STORE); const r=st.get(k); r.onsuccess=()=>res(r.result||null); r.onerror=()=>rej(r.error); }); }
async function setKV(k,v){ const d=await idb(); return new Promise((res,rej)=>{ const tx=d.transaction(STORE,'readwrite'); const st=tx.objectStore(STORE); const r=st.put(v,k); r.onsuccess=()=>res(); r.onerror=()=>rej(r.error); }); }
async function delKV(k){ const d=await idb(); return new Promise((res,rej)=>{ const tx=d.transaction(STORE,'readwrite'); const st=tx.objectStore(STORE); const r=st.delete(k); r.onsuccess=()=>res(); r.onerror=()=>rej(r.error); }); }

const KEY_BUF='template_buf', KEY_NAME='template_name', KEY_MAP='map_json_v1';

// Elements
const storedInfo = document.getElementById('storedInfo');
const citySel = document.getElementById('city');
const citySearch = document.getElementById('citySearch');
const dateInput = document.getElementById('date');
const tbMap = document.getElementById('tbMap');
const statMatched = document.getElementById('statMatched');
const statTotal = document.getElementById('statTotal');
const hideMatched = document.getElementById('hideMatched');
const onlyProblems = document.getElementById('onlyProblems');
const optionFilter = document.getElementById('optionFilter');

// picker
const picker = document.getElementById('picker');
const pickerQuery = document.getElementById('pickerQuery');
const pickerResults = document.getElementById('pickerResults');
const pickerClose = document.getElementById('pickerClose');

dateInput.value = new Date().toISOString().slice(0,10);
document.getElementById('clearOrder').onclick = ()=>{ document.getElementById('order').value=''; };

let templateBuf=null, templateName=null;
let catalog=[], assignments=[], mapMem=new Map(), lastRows=[], rowMetas=[];

function normStr(s){ return String(s||'').toLowerCase()
 .replace(/[ё]/g,'е').replace(/[“”«»„‟"']/g,'').replace(/[–—―−‐‑]/g,'-').replace(/[_/\\]/g,' ')
 .replace(/\s*\([^)]*\)\s*/g,' ').replace(/\s*\[[^\]]*\]\s*/g,' ')
 .replace(/\s+-\s+/g,'-').replace(/\s{2,}/g,' ').trim(); }
function normalizeLines(t){ return t.replace(/\u00A0/g,' ').replace(/\r\n|\n|\r/g,'\n'); }
function findStartIndex(lines){ for(let i=0;i<lines.length;i++){ const s=lines[i].toLowerCase().replace(/[^\p{L}]+/gu,'').trim(); if(s.startsWith('наименование')) return i+1; } return -1; }
function lastNumberLax(str){ const m=str.match(/(\d+(?:[.,]\d+)?)(?:\D*)$/u); if(!m) return null; const v=parseFloat(m[1].replace(',','.')); return Number.isFinite(v)?v:null; }
function parseOrder(text){ const lines=normalizeLines(text).split('\n'); const start=findStartIndex(lines); const rows=[]; if(start<0) return rows; for(let i=start;i<lines.length;i++){ let line=lines[i].trim(); if(!line) continue; const qty=lastNumberLax(line); if(qty==null) continue; line=line.replace(/(\d+(?:[.,]\d+)?)(?:\D*)$/u,'').trim(); if(!line) continue; rows.push([line,qty]); } return rows; }

// Load remembered template and map
(async()=>{
  try{
    const buf = await getKV(KEY_BUF); const name=await getKV(KEY_NAME);
    if(buf){ templateBuf=buf; templateName=name||'(запомненный)'; storedInfo.textContent = 'Шаблон: '+templateName; }
    try{ const raw=await getKV(KEY_MAP); if(raw){ mapMem=new Map(JSON.parse(raw)); renderMapEditor(); }}catch{}
  }catch(e){ setInfo('IndexedDB недоступен', true); }
})();

document.getElementById('remember').onclick = async ()=>{
  const f=document.getElementById('tmpl').files[0]; if(!f){ setInfo('Выберите .xlsx',true); return; }
  const buf=await f.arrayBuffer(); await setKV(KEY_BUF, buf); await setKV(KEY_NAME, f.name);
  templateBuf=buf; templateName=f.name; storedInfo.textContent='Шаблон: '+f.name; setInfo('Шаблон запомнен');
};
document.getElementById('clearStored').onclick = async ()=>{
  await delKV(KEY_BUF); await delKV(KEY_NAME); templateBuf=null; templateName=null; storedInfo.textContent=''; setInfo('Шаблон забыли');
};

function applyRowFlags(tr, unmatched, dup){ tr.classList.toggle('unmatched', !!unmatched); tr.classList.toggle('duplicate', !!dup); }
function applyFilters(){
  const hide = hideMatched.checked, prob = onlyProblems.checked;
  for(const m of rowMetas){
    const r = m.sel.value ? parseInt(m.sel.value,10) : null;
    const unmatched = (r==null), dup = m.isDup;
    let show = true;
    if(hide && !unmatched) show=false;
    if(prob && !(unmatched||dup)) show=false;
    m.tr.style.display = show ? '' : 'none';
  }
}
hideMatched.addEventListener('change', applyFilters);
onlyProblems.addEventListener('change', applyFilters);

function rebuildOptions(sel, filter){
  const keep = sel.value;
  sel.innerHTML = '<option value=\"\">— выберите —</option>' + catalog.filter(c=>!filter||c.norm.includes(filter)).map(c=>`<option value=\"${c.r}\">${c.text.replace(/</g,'&lt;').replace(/>/g,'&gt;')}</option>`).join('');
  if(keep && [...sel.options].some(o=>o.value===String(keep))) sel.value=String(keep);
}
optionFilter.addEventListener('input', ()=>{
  const f=normStr(optionFilter.value);
  for(const m of rowMetas) rebuildOptions(m.sel, f);
});

function autoMatch(src){
  const key=normStr(src); const mem=mapMem.get(key); if(mem) return parseInt(mem,10);
  const hit=catalog.find(n=>n.norm.includes(key)||key.includes(n.norm)); return hit?hit.r:null;
}
function updateStats(){
  const total=lastRows.reduce((s,[,q])=>s+Number(q||0),0);
  const matched=assignments.reduce((s,a)=>s+(a.destR!=null?1:0),0);
  statMatched.textContent=`Совпадений: ${matched} / ${lastRows.length}`;
  statTotal.textContent=`Итого заказано единиц: ${total}`;
}

// Search overlay logic
let activePickerSel = null;
function openPicker(forSelect){
  activePickerSel = forSelect;
  picker.style.display='flex';
  pickerQuery.value='';
  renderPickerResults('');
  pickerQuery.focus();
}
function closePicker(){ picker.style.display='none'; activePickerSel=null; }
pickerClose.onclick = closePicker;
picker.addEventListener('click', (e)=>{ if(e.target===picker) closePicker(); });
window.addEventListener('keydown', (e)=>{ if(e.key==='Escape') closePicker(); });

function renderPickerResults(q){
  const terms = normStr(q).split(' ').filter(Boolean);
  const filtered = catalog.filter(c=> terms.every(t => c.norm.includes(t)) );
  pickerResults.innerHTML = filtered.map(c=>`<div class="resitem" data-r="${c.r}">${c.text.replace(/</g,'&lt;').replace(/>/g,'&gt;')}</div>`).join('') || '<div class="resitem">Ничего не найдено</div>';
  for(const div of pickerResults.querySelectorAll('.resitem[data-r]')){
    div.onclick = ()=>{
      if(activePickerSel){
        activePickerSel.value = div.dataset.r;
        activePickerSel.dispatchEvent(new Event('change'));
      }
      closePicker();
    };
  }
}
pickerQuery.addEventListener('input', ()=> renderPickerResults(pickerQuery.value) );

// Read catalog + restaurants from template
async function readCatalogAndL1(){
  const f=document.getElementById('tmpl').files[0];
  const buf = f?await f.arrayBuffer():(templateBuf||await getKV(KEY_BUF));
  if(!buf) throw new Error('Нет шаблона');
  const wb = XLSX.read(buf,{type:'array',cellText:true,cellDates:true,cellNF:true});
  const order = wb.Sheets['Order']; if(!order) throw new Error('Нет листа Order');
  // build catalog from D column
  const ref = order['!ref'] || 'A1'; const range=XLSX.utils.decode_range(ref);
  const list=[]; for(let r=14;r<=range.e.r+1;r++){ const addr=XLSX.utils.encode_cell({c:3,r:r-1}); const cell=order[addr];
    if(!cell) continue; const text=(cell.w!=null?String(cell.w):(cell.v!=null?String(cell.v):'')).trim(); if(text) list.push({r,text,norm:normStr(text)}); }
  catalog = list;
  // L1 restaurants
  const l1 = wb.Sheets['L1'];
  if(l1 && !citySel.options.length){
    const rows=XLSX.utils.sheet_to_json(l1,{header:1,defval:''});
    citySel.innerHTML='';
    for(let i=1;i<rows.length;i++){ const code=String(rows[i][1]??'').trim(); const city=String(rows[i][2]??'').trim();
      if(city){ const o=document.createElement('option'); o.value=city; o.textContent=city; o.dataset.code=code; citySel.appendChild(o);} }
  }
  return buf; // return template buffer
}

function buildTable(rows){
  tbMap.innerHTML=''; assignments=[]; lastRows=rows; rowMetas=[];
  const counts=new Map(); for(const [s] of rows){ const k=normStr(s); counts.set(k,(counts.get(k)||0)+1); }
  for(const [src,qty] of rows){
    const tr=document.createElement('tr');
    const wrap=document.createElement('div'); wrap.className='selectWrap';
    const sel=document.createElement('select'); sel.innerHTML='';
    const cover=document.createElement('button'); cover.type='button'; cover.className='selectCover'; cover.title='Поиск';
    wrap.appendChild(sel); wrap.appendChild(cover);
    tr.innerHTML=`<td class="warn"></td><td></td><td>${qty}</td>`;
    tr.children[0].textContent=src;
    tr.children[1].appendChild(wrap);
    tbMap.appendChild(tr);
    rebuildOptions(sel,'');
    cover.addEventListener('click', ()=> openPicker(sel) );

    const pre=autoMatch(src); if(pre) sel.value=String(pre);
    const isDup=(counts.get(normStr(src))||0)>1;
    function upd(){
      const r = sel.value?parseInt(sel.value,10):null;
      const idx=assignments.findIndex(a=>a.src===src); if(idx>=0) assignments[idx]={src,qty,destR:r}; else assignments.push({src,qty,destR:r});
      if(r!=null){ mapMem.set(normStr(src),String(r)); setKV(KEY_MAP, JSON.stringify([...mapMem.entries()])); renderMapEditor(); }
      applyRowFlags(tr, r==null, isDup); applyFilters(); updateStats();
    }
    sel.addEventListener('change',upd);
    rowMetas.push({tr,sel,isDup});
    applyRowFlags(tr, pre==null, isDup); upd();
  }
}

document.getElementById('preview').onclick = async ()=>{
  try{
    setInfo('');
    await readCatalogAndL1();
    const rows=parseOrder(document.getElementById('order').value);
    buildTable(rows);
    setInfo(`Каталог: ${catalog.length}.`);
  }catch(e){ setInfo(e.message,true); }
};

document.getElementById('download').onclick = async ()=>{
  try{
    setInfo('');
    const buf = await readCatalogAndL1(); // ensures we have catalog & restaurants
    const wb = await XlsxPopulate.fromDataAsync(buf);
    const order=wb.sheet('Order'); const l1=wb.sheet('L1');
    // D2 — код + город
    const city = citySel.value || (citySel.options[0]?.value||'');
    let code=''; if(l1){ const end=l1.usedRange().endCell().rowNumber(); const nrm=s=>String(s??'').toLowerCase().trim();
      for(let r=2;r<=end;r++){ const b=l1.cell(r,2).value(), c=l1.cell(r,3).value(); if(nrm(c)===nrm(city)){ code=(typeof b==='number')?String(Math.trunc(b)):String(b??''); break; } } }
    const merged = (city==='Тольятти-5') ? '1369-Тольятти-5' : (code ? `${code} - ${city}` : city);
    order.cell('D2').value(merged);
    // D8 — дата
    const dt=document.getElementById('date').value; let ddmm='дата'; if(dt){ const [yy,mm,dd]=dt.split('-'); order.cell('D8').value(`${dd}.${mm}.${yy}`); ddmm=`${dd}.${mm}.${yy}`; }
    // F — количества
    const endRow=order.usedRange().endCell().rowNumber(); for(let r=14;r<=endRow;r++) order.cell(r,6).value(null);
    let written=0; for(const a of assignments){ if(a.destR!=null && a.destR>=14 && a.destR<=endRow){ order.cell(a.destR,6).value(a.qty); written++; } }
    const out=await wb.outputAsync(); const blob=new Blob([out],{type:'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet'});
    const a=document.createElement('a'); a.href=URL.createObjectURL(blob); const base=city||'EWL_Order'; a.download=`${base} ${ddmm}.xlsx`; a.click(); setTimeout(()=>URL.revokeObjectURL(a.href),1500);
    setInfo(`Скачано. Записано позиций: ${written}`);
  }catch(e){ setInfo(e.message,true); }
};

// Search pizzeria
citySearch.addEventListener('input',()=>{
  const q=normStr(citySearch.value);
  for(const opt of citySel.options){ const show=!q||normStr(opt.textContent).includes(q); opt.style.display=show?'':'none'; }
});

/*** Mapping editor ***/
const mapBody = document.getElementById('mapBody');
function renderMapEditor(){
  mapBody.innerHTML='';
  for(const [k,v] of mapMem.entries()){
    const tr=document.createElement('tr');
    tr.innerHTML = `<td contenteditable="true" class="key">${k}</td><td contenteditable="true" class="val">${v}</td><td><button class="btn mini">✕</button></td>`;
    const del = tr.querySelector('button');
    del.onclick=()=>{ mapMem.delete(k); setKV(KEY_MAP, JSON.stringify([...mapMem.entries()])); renderMapEditor(); };
    tr.querySelector('.key').onblur=()=>{
      const newK = tr.querySelector('.key').textContent.trim();
      const oldV = tr.querySelector('.val').textContent.trim();
      mapMem.delete(k); mapMem.set(newK, oldV); setKV(KEY_MAP, JSON.stringify([...mapMem.entries()]));
    };
    tr.querySelector('.val').onblur=()=>{
      const newV = tr.querySelector('.val').textContent.trim();
      mapMem.set(k, newV); setKV(KEY_MAP, JSON.stringify([...mapMem.entries()]));
    };
    mapBody.appendChild(tr);
  }
}
document.getElementById('exportMap').onclick=()=>{
  const blob=new Blob([JSON.stringify([...mapMem.entries()], null, 2)], {type:'application/json'});
  const a=document.createElement('a'); a.href=URL.createObjectURL(blob); a.download='ewl_mapping.json'; a.click(); setTimeout(()=>URL.revokeObjectURL(a.href), 1200);
};
document.getElementById('importMap').onclick=()=> document.getElementById('importMapFile').click();
document.getElementById('importMapFile').onchange=async(e)=>{
  const f=e.target.files[0]; if(!f) return;
  const txt=await f.text();
  try{ const arr=JSON.parse(txt); mapMem = new Map(arr); await setKV(KEY_MAP, JSON.stringify(arr)); renderMapEditor(); setInfo('Импортировано'); }catch{ setInfo('Ошибка импорта JSON', true); }
};
document.getElementById('clearMap').onclick=async()=>{ if(confirm('Очистить память соответствий?')){ mapMem.clear(); await setKV(KEY_MAP, JSON.stringify([...mapMem.entries()])); renderMapEditor(); } };
</script>
</body>
</html>
