<!doctype html>
<html lang="ru">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>EWL Order — текстовая память соответствий</title>
<link rel="shortcut icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg'/>">
<script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/xlsx-populate/browser/xlsx-populate.min.js"></script>

<style>
  :root{--bg:#0b1020;--fg:#eaf0ff;--mut:#9fb2ff;--panel:#121a34;--border:#7aa2ff40;--accent:#1b2750}
  *{box-sizing:border-box}
  body{font-family:system-ui,Segoe UI,Roboto,Arial,sans-serif;background:var(--bg);color:var(--fg);margin:0;padding:24px}
  .card{background:var(--panel);border:1px solid var(--border);border-radius:16px;max-width:1360px;margin:0 auto;padding:18px}
  h1{margin:0 0 10px}

  input,select,textarea,button{
    width:100%;
    border-radius:12px;
    border:1px solid #7aa2ff55;
    background:#0f1530;
    color:var(--fg);
    padding:10px;
    margin-top:6px;
  }
  textarea{min-height:220px;white-space:pre;font-family:ui-monospace,Consolas,Menlo,monospace}

  .btn{cursor:pointer;font-weight:700;background:var(--accent);width:auto;display:inline-block;margin-right:8px}

  table{border-collapse:collapse;width:100%;margin-top:12px}
  th,td{border-bottom:1px solid #7aa2ff55;padding:8px;vertical-align:top}
  th{color:var(--mut)}

  tr.unmatched td{background:#51202a}
  tr.duplicate td{background:#58461c}
  tr.unmatched.duplicate td{background:#60313a}

  .legend{display:flex;gap:10px;align-items:center;margin-top:6px;flex-wrap:wrap}
  .chip{display:inline-block;padding:4px 8px;border-radius:999px;border:1px solid #7aa2ff55}
  .chip.unm{background:#51202a}
  .chip.dupl{background:#58461c}

  .toolbar{display:flex;gap:10px;align-items:center;flex-wrap:wrap;margin:8px 0}

  #info{min-height:20px}
  .error{color:#ffa2a2}
  .ok{color:#b5ffbf}

  .modal{position:fixed;inset:0;background:#0008;display:none;align-items:center;justify-content:center;z-index:50}
  .modal>.box{background:#0f1530;border:1px solid #7aa2ff55;border-radius:14px;max-width:900px;width:90%;padding:12px}
  .modal input{width:100%}
  .results{max-height:420px;overflow:auto;margin-top:8px;border:1px solid #7aa2ff33;border-radius:10px}
  .resitem{padding:8px 10px;border-bottom:1px solid #7aa2ff22;cursor:pointer}
  .resitem:hover{background:#15204a}
  .selectWrap{position:relative}
  .selectWrap select{pointer-events:auto}
  .selectCover{position:absolute;inset:0;background:transparent;border:none;border-radius:12px;cursor:pointer}

  /* компактные чекбоксы */
  input[type="checkbox"]{
    width:14px;height:14px;border-radius:4px;accent-color:#7aa2ff;vertical-align:middle
  }
  label.inline{display:inline-flex;align-items:center;gap:6px;margin:0}

  /* редактор внизу — details */
  details.editor{margin-top:10px}
  details.editor > summary{cursor:pointer;color:var(--mut,#9fb2ff);list-style:disclosure-closed}
  details.editor[open] > summary{list-style:disclosure-open}

  /* --- фикс: редактор внизу, в одну колонку --- */
  .row{display:block!important}
  #mapCard,.map-card,.right,#rightPane,.rightCol{position:static!important;top:auto!important;width:100%!important;float:none!important;clear:both!important;margin-top:16px!important}
  #mapTable,.map-table,#tbMap{max-height:none!important;overflow:visible!important}
  details.editor{display:block!important;width:100%!important;grid-column:1/-1!important;margin-top:10px!important}

  /* === Компактные ширины === */
  #date{width:100%;max-width:260px}

  /* Комбинированный контрол города */
  .combo{position:relative;width:100%;max-width:560px}
  .combo input{padding-right:34px}
  .combo .arrow{
    position:absolute;right:10px;top:50%;transform:translateY(-50%);
    pointer-events:none;opacity:.8
  }
  .combo-list{
    position:absolute;left:0;right:0;top:calc(100% + 6px);
    background:#0f1530;border:1px solid #7aa2ff55;border-radius:12px;
    max-height:320px;overflow:auto;display:none;z-index:20
  }
  .combo-list.open{display:block}
  .combo-item{padding:8px 10px;border-bottom:1px solid #7aa2ff22;cursor:pointer}
  .combo-item:hover{background:#15204a}

  @media (max-width:720px){
    #date,.combo{max-width:100%}
  }
</style>
</head>

<body>
  <div class="card">
    <h1>EWL Order</h1>

    <!-- Ввод и управление -->
    <div>
      <label>Шаблон (.xlsx)
        <input type="file" id="tmpl" accept=".xlsx,application/vnd.openxmlformats-officedocument.spreadsheetml.sheet">
      </label>
      <div class="inline-controls" style="margin-top:8px">
        <button class="btn" id="remember">Запомнить шаблон</button>
        <button class="btn" id="clearStored">Забыть</button>
        <span id="storedInfo" class="muted"></span>
      </div>

      <div class="inline-controls" style="margin-top:12px;gap:14px;align-items:flex-start;flex-wrap:wrap">
  <label>Дата
    <input type="date" id="date">
  </label>
</div>

<label style="flex:1 1 560px;display:block;margin-top:12px">Ресторан
  <div class="combo" id="cityComboBox">
    <input id="cityCombo" placeholder="Начните ввод…">
    <svg class="arrow" width="16" height="16" viewBox="0 0 24 24">
      <path fill="currentColor" d="M7 10l5 5 5-5z"/>
    </svg>
    <div class="combo-list" id="cityList"></div>
  </div>
</label>


      <label style="margin-top:14px">Текст заказа
        <textarea id="order" placeholder="Вставьте заказ сюда..."></textarea>
      </label>
      <button class="btn" id="clearOrder" style="margin-top:6px">Очистить текст</button>


      

      <div class="toolbar">
        <button class="btn" id="preview">Предпросмотр</button>
        <button class="btn" id="download">Скачать Excel</button>
        <label class="inline"><input type="checkbox" id="hideMatched"> Скрывать совпавшие</label>
        <label class="inline"><input type="checkbox" id="onlyProblems"> Только проблемные</label>
      </div>

      <div class="legend">
        <span class="chip unm">не найдено</span>
        <span class="chip dupl">повтор</span>
        <span id="statMatched" class="muted">Совпадений: 0 / 0</span>
        <span id="statTotal" class="muted">Итого заказано единиц: 0</span>
      </div>

      <div id="info" style="margin-top:6px"></div>

      <table>
        <thead><tr><th>Наименование (из заказа)</th><th>Соответствие (каталог)</th><th>Кол-во</th></tr></thead>
        <tbody id="tbMap"></tbody>
      </table>
    </div>

    <!-- Редактор соответствий внизу -->
    <details class="editor" id="mapEditor">
      <summary>Редактор соответствий (память)</summary>
      <div style="margin-top:10px">
        <div style="margin-bottom:8px;display:flex;gap:10px;flex-wrap:wrap">
          <button id="exportMap" class="btn">Экспорт JSON</button>
          <button id="importMap" class="btn">Импорт JSON</button>
          <input id="importMapFile" type="file" accept=".json" style="display:none">
          <button id="clearMap" class="btn">Очистить</button>
        </div>
        <table id="mapTable">
          <thead>
            <tr>
              <th>Ключ (из заказа)</th>
              <th>Значение (каталог / #ROW:n)</th>
              <th></th>
            </tr>
          </thead>
          <tbody id="mapBody"></tbody>
        </table>
      </div>
    </details>
  </div>

  <!-- Модальная лупа по каталогу -->
  <div class="modal" id="picker">
    <div class="box">
      <div style="display:flex;gap:8px;align-items:center">
        <input id="pickerQuery" placeholder="Ищите по подстроке…">
        <button class="btn" id="pickerClose" style="margin:0">Закрыть</button>
      </div>
      <div class="results" id="pickerResults"></div>
    </div>
  </div>

<script>
/* ====================== БАЗОВЫЕ УТИЛЫ ====================== */
const LS_KEY='ewl_map_v2';
function norm(s){return String(s||'').toLowerCase().replace(/[ё]/g,'е').replace(/["'`]/g,'').replace(/\s+/g,' ').trim();}

function loadMemory(){try{const raw=localStorage.getItem(LS_KEY);if(!raw) return {version:2,map:{}};const data=JSON.parse(raw);if(!data.map) return {version:2,map:{}};return {version:2,map:data.map};}catch{return {version:2,map:{}}}}
function saveMemory(obj){localStorage.setItem(LS_KEY, JSON.stringify(obj));}
function rememberMatch(srcText, templText){const mem=loadMemory();mem.map[norm(srcText)]=norm(templText);saveMemory(mem);}
function forgetMatch(srcText){const mem=loadMemory();delete mem.map[norm(srcText)];saveMemory(mem);}

function parseOrder(text){
  const lines=String(text||'').split(/\r?\n/);let start=0;
  for(let i=0;i<lines.length;i++){ if(/наименован/i.test(lines[i])){start=i+1;break;} }
  const out=[];
  for(let i=start;i<lines.length;i++){
    const line=lines[i].trim(); if(!line) continue;
    const m=line.match(/(.+?)\s+(-?\d+(?:[.,]\d+)?)\s*$/);
    if(m){ out.push([m[1].trim(), parseFloat(m[2].replace(',', '.'))]); }
  }
  return out;
}
function setInfo(msg,isErr=false){const box=document.getElementById('info'); if(!box) return; box.innerHTML=isErr?`<span class="error">${msg}</span>`:`<span class="ok">${msg}</span>`;}

/* ================= IndexedDB и кэш ================= */
const DB='ewl_order_prod_db', STORE='kv', KEY_BUF='template_buf', KEY_NAME='template_name', KEY_CITIES='cities_cache_v1';
function idb(){return new Promise((res,rej)=>{const r=indexedDB.open(DB,1);r.onupgradeneeded=()=>r.result.createObjectStore(STORE);r.onsuccess=()=>res(r.result);r.onerror=()=>rej(r.error);});}
async function getKV(k){const d=await idb();return new Promise((res,rej)=>{const tx=d.transaction(STORE,'readonly'),st=tx.objectStore(STORE),r=st.get(k);r.onsuccess=()=>res(r.result||null);r.onerror=()=>rej(r.error);});}
async function setKV(k,v){const d=await idb();return new Promise((res,rej)=>{const tx=d.transaction(STORE,'readwrite'),st=tx.objectStore(STORE),r=st.put(v,k);r.onsuccess=()=>res();r.onerror=()=>rej(r.error);});}
async function delKV(k){const d=await idb();return new Promise((res,rej)=>{const tx=d.transaction(STORE,'readwrite'),st=tx.objectStore(STORE),r=st.delete(k);r.onsuccess=()=>res();r.onerror=()=>rej(r.error);});}

/* ======= Глобальные ======= */
let catalog=[];       // [{r,text,norm}]
let assignments=[];   // [{src,qty,destR}]
let lastRows=[];      // [[src,qty]...]
let rowMetas=[];      // [{tr,sel,isDup}...]

let citiesArray=[];         // [{code,name}]
let citySelected='';        // строка выбранного города

/* ======= Комбинированный контрол города ======= */
const cityCombo = document.getElementById('cityCombo');
const cityList  = document.getElementById('cityList');
const cityBox   = document.getElementById('cityComboBox');

function renderCityList(filter=''){
  const q = norm(filter);
  const list = citiesArray
    .filter(c => !q || norm(c.name).includes(q))
    .map(c => `<div class="combo-item" data-name="${c.name.replace(/"/g,'&quot;')}">${c.name}</div>`)
    .join('') || '<div class="combo-item" style="pointer-events:none;opacity:.6">Ничего не найдено</div>';
  cityList.innerHTML = list;
  for(const it of cityList.querySelectorAll('.combo-item[data-name]')){
    it.onclick = () => { citySelected = it.dataset.name; cityCombo.value = citySelected; cityList.classList.remove('open'); };
  }
}

function openCityList(){ renderCityList(cityCombo.value); cityList.classList.add('open'); }
function closeCityList(){ cityList.classList.remove('open'); }

cityCombo.addEventListener('focus', openCityList);
cityCombo.addEventListener('input', ()=>{ openCityList(); });
cityCombo.addEventListener('keydown', (e)=>{
  if(e.key==='Enter'){
    const first=cityList.querySelector('.combo-item[data-name]'); 
    if(first){ first.click(); e.preventDefault(); }
  }
});
document.addEventListener('click', (e)=>{
  if(!cityBox.contains(e.target)) closeCityList();
});
cityBox.addEventListener('click', ()=>{
  if(cityList.classList.contains('open')) closeCityList(); else openCityList();
});

/* ---- загрузка/сохранение городов ---- */
async function getCachedCities(){ try { return await getKV(KEY_CITIES); } catch { return null; } }
async function setCachedCities(cities){ try { await setKV(KEY_CITIES, cities); } catch {} }

/* ================= Автозагрузка при старте ================= */
(async()=>{
  try{
    const buf  = await getKV(KEY_BUF);
    const name = await getKV(KEY_NAME);
    if(buf){ window.templateBuf=buf; window.templateName=name||'(запомненный)'; const storedInfo=document.getElementById('storedInfo'); if(storedInfo) storedInfo.textContent='Шаблон: '+window.templateName; }

    const cachedCities = await getCachedCities();
    if(cachedCities && cachedCities.length){
      citiesArray = cachedCities;
      renderCityList('');
    }
    renderMapEditor();
  }catch(e){ setInfo('IndexedDB недоступен (шаблон/справочник не будут запоминаться)',true); }
})();

/* ================= Кнопки "Запомнить/Забыть шаблон" ================= */
document.getElementById('remember').onclick=async()=>{
  const f=document.getElementById('tmpl').files[0];
  if(!f){ setInfo('Выберите .xlsx',true); return; }
  const buf=await f.arrayBuffer(); await setKV(KEY_BUF,buf); await setKV(KEY_NAME,f.name);
  window.templateBuf=buf; window.templateName=f.name;
  const storedInfo=document.getElementById('storedInfo'); if(storedInfo) storedInfo.textContent='Шаблон: '+f.name;
  setInfo('Шаблон запомнен');
  if(citiesArray && citiesArray.length){ await setCachedCities(citiesArray); renderCityList(''); }
};

document.getElementById('clearStored').onclick=async()=>{
  await delKV(KEY_BUF); await delKV(KEY_NAME); window.templateBuf=null; window.templateName=null;
  const storedInfo=document.getElementById('storedInfo'); if(storedInfo) storedInfo.textContent='';
  setInfo('Шаблон забыли');
};

/* ------------------- чтение шаблона ------------------- */
async function readCatalogAndL1(){
  const f=document.getElementById('tmpl').files[0];
  const buf = f?await f.arrayBuffer():(window.templateBuf||await getKV(KEY_BUF));
  if(!buf) throw new Error('Нет шаблона');

  const wb = XLSX.read(buf,{type:'array',cellText:true,cellDates:true,cellNF:true});
  const order=wb.Sheets['Order']; if(!order) throw new Error('Нет листа Order');

  const ref=order['!ref']||'A1'; const range=XLSX.utils.decode_range(ref);
  const list=[];
  for(let r=14;r<=range.e.r+1;r++){
    const addr=XLSX.utils.encode_cell({c:3,r:r-1}); // D
    const cell=order[addr];
    if(!cell) continue;
    const text=(cell.w!=null?String(cell.w):(cell.v!=null?String(cell.v):'')).trim();
    if(text) list.push({r,text,norm:norm(text)});
  }
  catalog=list;

  const l1=wb.Sheets['L1'];
  if(l1){
    const rows=XLSX.utils.sheet_to_json(l1,{header:1,defval:''});
    const arr=[];
    for(let i=1;i<rows.length;i++){
      const code=String(rows[i][1]??'').trim();
      const city=String(rows[i][2]??'').trim();
      if(city) arr.push({code,name:city});
    }
    if(arr.length){
      citiesArray=arr; renderCityList('');
      await setCachedCities(arr);
    }
  }
  return buf;
}

/* ====== индексы/автосопоставление ====== */
function buildTemplateIndex(){const idx=new Map(); for(const c of catalog){ idx.set(c.norm,c.r);} return idx;}
function autoMatchByIncludes(userTextNorm){
  let hit=catalog.find(c=>c.norm.includes(userTextNorm)||userTextNorm.includes(c.norm));
  if(hit) return hit.r;
  const terms=userTextNorm.split(' ').filter(Boolean);
  hit=catalog.find(c=>terms.every(t=>c.norm.includes(t)));
  return hit?hit.r:null;
}

function updateStats(){
  const total=lastRows.reduce((s,[,q])=>s+Number(q||0),0);
  const matched=assignments.reduce((s,a)=>s+(a.destR!=null?1:0),0);
  document.getElementById('statMatched').textContent=`Совпадений: ${matched} / ${lastRows.length}`;
  document.getElementById('statTotal').textContent=`Итого заказано единиц: ${total}`;
}

/* ====== модальная лупа по каталогу ====== */
const picker=document.getElementById('picker');
const pickerQuery=document.getElementById('pickerQuery');
const pickerResults=document.getElementById('pickerResults');
const pickerClose=document.getElementById('pickerClose');

pickerQuery.addEventListener('input',e=>renderPickerResults(e.target.value));
pickerQuery.addEventListener('keydown',e=>{
  if(e.key==='Enter'){const first=pickerResults.querySelector('.resitem[data-r]'); if(first){first.click(); e.preventDefault();}}
});
let activePickerSel=null;
function openPicker(forSelect){activePickerSel=forSelect; picker.style.display='flex'; pickerQuery.value=''; renderPickerResults(''); pickerQuery.focus();}
function closePicker(){picker.style.display='none'; activePickerSel=null;}
pickerClose.onclick=closePicker; picker.addEventListener('click',e=>{if(e.target===picker) closePicker();});
window.addEventListener('keydown',e=>{if(e.key==='Escape') closePicker();});

function renderPickerResults(q){
  const terms=norm(q).split(' ').filter(Boolean);
  const filtered=catalog.filter(c=>terms.every(t=>c.norm.includes(t)));
  pickerResults.innerHTML = filtered.map(c=>`<div class="resitem" data-r="${c.r}">${c.text.replace(/</g,'&lt;').replace(/>/g,'&gt;')}</div>`).join('') || '<div class="resitem">Ничего не найдено</div>';
  for(const div of pickerResults.querySelectorAll('.resitem[data-r]')){
    div.onclick=()=>{ if(activePickerSel){ activePickerSel.value=div.dataset.r; activePickerSel.dispatchEvent(new Event('change')); } closePicker(); };
  }
}

/* фильтры по строке справа */
const optionFilter=document.getElementById('optionFilter');
optionFilter.addEventListener('input', ()=>{
  const f=norm(optionFilter.value);
  for(const m of rowMetas) rebuildOptions(m.sel,f);
});
function rebuildOptions(sel,filter){
  const keep=sel.value;
  sel.innerHTML='<option value="">— выберите —</option>' + catalog.filter(c=>!filter||c.norm.includes(filter)).map(c=>`<option value="${c.r}">${c.text.replace(/</g,'&lt;').replace(/>/g,'&gt;')}</option>`).join('');
  if(keep && [...sel.options].some(o=>o.value===String(keep))) sel.value=String(keep);
}

function applyRowFlags(tr,unmatched,dup){tr.classList.toggle('unmatched',!!unmatched); tr.classList.toggle('duplicate',!!dup);}
function applyFilters(){
  const hide=document.getElementById('hideMatched').checked, prob=document.getElementById('onlyProblems').checked;
  for(const m of rowMetas){
    const r=m.sel.value?parseInt(m.sel.value,10):null;
    const unmatched=(r==null), dup=m.isDup;
    let show=true; if(hide && !unmatched) show=false; if(prob && !(unmatched||dup)) show=false;
    m.tr.style.display=show?'':'none';
  }
}
document.getElementById('hideMatched').addEventListener('change',applyFilters);
document.getElementById('onlyProblems').addEventListener('change',applyFilters);

/* постройка таблицы */
function buildTable(rows){
  const tbMap=document.getElementById('tbMap'); tbMap.innerHTML=''; assignments=[]; lastRows=rows; rowMetas=[];
  const counts=new Map(); for(const [s] of rows){const k=norm(s); counts.set(k,(counts.get(k)||0)+1);}

  const mem=loadMemory(); const templateIdx=buildTemplateIndex();

  for(const [src,qty] of rows){
    const tr=document.createElement('tr');
    const wrap=document.createElement('div'); wrap.className='selectWrap';
    const sel=document.createElement('select'); sel.innerHTML='';
    const cover=document.createElement('button'); cover.type='button'; cover.className='selectCover'; cover.title='Поиск';
    wrap.appendChild(sel); wrap.appendChild(cover);
    tr.innerHTML=`<td class="warn"></td><td></td><td>${qty}</td>`;
    tr.children[0].textContent=src;
    tr.children[1].appendChild(wrap);
    tbMap.appendChild(tr);
    rebuildOptions(sel,'');

    cover.addEventListener('click',()=>openPicker(sel));

    const key=norm(src);
    let preR=null;
    const savedTemplNorm=mem.map[key];
    if(savedTemplNorm){
      if(savedTemplNorm.startsWith('#ROW:')){
        const row=parseInt(savedTemplNorm.slice(5),10); if(Number.isFinite(row)) preR=row;
      } else { const row=templateIdx.get(savedTemplNorm); if(row) preR=row; }
    } else { preR=autoMatchByIncludes(key); }
    if(preR) sel.value=String(preR);

    const isDup=(counts.get(key)||0)>1;
    function upd(){
      const r=sel.value?parseInt(sel.value,10):null;
      const idx=assignments.findIndex(a=>a.src===src);
      if(idx>=0) assignments[idx]={src,qty,destR:r}; else assignments.push({src,qty,destR:r});
      if(r!=null){ const chosen=catalog.find(c=>c.r===r); if(chosen) rememberMatch(src,chosen.text); } else { forgetMatch(src); }
      applyRowFlags(tr,r==null,isDup); applyFilters(); updateStats();
    }
    sel.addEventListener('change',upd);
    rowMetas.push({tr,sel,isDup});
    applyRowFlags(tr,preR==null,isDup); upd();
  }
}

/* Предпросмотр */
document.getElementById('preview').onclick=async()=>{
  try{
    setInfo(''); await readCatalogAndL1();
    const rows=parseOrder(document.getElementById('order').value);
    buildTable(rows);
    setInfo(`Каталог загружен: ${catalog.length} позиций.`);
  }catch(e){ setInfo(e.message,true); }
};

/* Cкачивание Excel */
function safeFilename(s){return s.replace(/[\\/:*?"<>|]+/g,' ').replace(/\s{2,}/g,' ').trim();}
function buildFilename(){
  const city = citySelected || (citiesArray[0]?.name || 'EWL_Order');
  const dt=document.getElementById('date').value;
  let ddmm='дата'; if(dt){const [yyyy,mm,dd]=dt.split('-'); ddmm=`${dd}.${mm}.${yyyy}`;}
  return `${city} ${ddmm}.xlsx`;
}
document.getElementById('download').onclick=async()=>{
  try{
    setInfo('');
    const buf=await readCatalogAndL1();
    const wb=await XlsxPopulate.fromDataAsync(buf);
    const order=wb.sheet('Order'); const l1=wb.sheet('L1');

    const city = citySelected || (citiesArray[0]?.name || '');
    let code='';
    if(l1){
      const end=l1.usedRange().endCell().rowNumber();
      const nrm=s=>String(s??'').toLowerCase().trim();
      for(let r=2;r<=end;r++){
        const b=l1.cell(r,2).value(), c=l1.cell(r,3).value();
        if(nrm(c)===nrm(city)){ code=(typeof b==='number')?String(Math.trunc(b)):String(b??''); break; }
      }
    }
    const merged=(city==='Тольятти-5')?'1369-Тольятти-5':(code?`${code} - ${city}`:city);
    order.cell('D2').value(merged);

    const dt=document.getElementById('date').value;
    if(dt){ const [yy,mm,dd]=dt.split('-'); order.cell('D8').value(`${dd}.${mm}.${yy}`); }

    const endRow=order.usedRange().endCell().rowNumber();
    for(let r=14;r<=endRow;r++) order.cell(r,6).value(null);
    let written=0; for(const a of assignments){ if(a.destR!=null && a.destR>=14 && a.destR<=endRow){ order.cell(a.destR,6).value(a.qty); written++; } }

    const out=await wb.outputAsync(); const blob=new Blob([out],{type:'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet'});
    const a=document.createElement('a'); a.href=URL.createObjectURL(blob); a.download=safeFilename(buildFilename()); a.click(); setTimeout(()=>URL.revokeObjectURL(a.href),1500);
    setInfo(`Скачано. Записано позиций: ${written}`);
  }catch(e){ setInfo(e.message,true); }
};

/* ============ Редактор памяти ============ */
const mapBody=document.getElementById('mapBody');
function renderMapEditor(){
  const mem=loadMemory(); mapBody.innerHTML='';
  for(const [k,v] of Object.entries(mem.map)){
    let shownText=v;
    if(!v.startsWith('#ROW:')){ for(const c of catalog){ if(c.norm===v){ shownText=c.text; break; } } }
    const tr=document.createElement('tr');
    tr.innerHTML=`<td contenteditable="true" class="key">${k}</td>
                  <td contenteditable="true" class="val">${shownText}</td>
                  <td><button class="btn" style="padding:6px 10px">✕</button></td>`;
    const del=tr.querySelector('button');
    del.onclick=()=>{ const mem=loadMemory(); delete mem.map[k]; saveMemory(mem); renderMapEditor(); };
    tr.querySelector('.key').onblur=()=>{ const newK=norm(tr.querySelector('.key').textContent||''); const mem=loadMemory(); const cur=mem.map[k]; delete mem.map[k]; if(newK) mem.map[newK]=cur; saveMemory(mem); renderMapEditor(); };
    tr.querySelector('.val').onblur=()=>{ const newVal=norm(tr.querySelector('.val').textContent||''); const mem=loadMemory(); mem.map[k]=newVal; saveMemory(mem); renderMapEditor(); };
    mapBody.appendChild(tr);
  }
}
document.getElementById('exportMap').onclick=()=>{
  const mem=loadMemory(); const blob=new Blob([JSON.stringify(mem,null,2)],{type:'application/json'});
  const a=document.createElement('a'); a.href=URL.createObjectURL(blob); a.download='ewl_mapping_text.json'; a.click(); setTimeout(()=>URL.revokeObjectURL(a.href),1200);
};
document.getElementById('importMap').onclick=()=>document.getElementById('importMapFile').click();
document.getElementById('importMapFile').onchange=async(e)=>{
  const f=e.target.files[0]; if(!f) return;
  try{ const txt=await f.text(); const data=JSON.parse(txt); if(!data.map) throw new Error('Нет поля map');
    localStorage.setItem(LS_KEY, JSON.stringify({version:2,map:data.map})); renderMapEditor(); setInfo('Импортировано');
  }catch{ setInfo('Ошибка импорта JSON',true); }
};
document.getElementById('clearMap').onclick=async()=>{ if(confirm('Очистить память соответствий?')){ localStorage.removeItem(LS_KEY); renderMapEditor(); } };
document.getElementById('clearOrder').onclick = () => {
  document.getElementById('order').value = '';
};


  
</script>
</body>
</html>

