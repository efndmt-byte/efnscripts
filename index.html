<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>EWL Order</title>
  <link rel="icon" type="image/x-icon" href="favicon.ico">
  <link rel="icon" type="image/png" sizes="16x16" href="favicon-16x16.png">
  <link rel="icon" type="image/png" sizes="32x32" href="favicon-32x32.png">
  <style>
    :root{--bg:#01020a;--fg:#eaf0ff;--mut:#9fb2ff;--panel:rgba(15,23,42,.80);--border:rgba(148,163,184,.22);--accent:#1b2750}
    *{box-sizing:border-box}
    body{font-family:system-ui,Segoe UI,Roboto,Arial,sans-serif;background:radial-gradient(1200px 420px at 50% 0%, rgba(255,226,163,.06), transparent 62%),radial-gradient(900px 360px at 80% 10%, rgba(255,214,138,.04), transparent 60%),radial-gradient(900px 520px at 20% 0%, rgba(120,170,255,.04), transparent 60%),linear-gradient(180deg,#01020a 0%,#020412 35%,#03061a 100%);color:var(--fg);margin:0;padding:24px}}
    .card{background:var(--panel);border:1px solid var(--border);border-radius:16px;max-width:1360px;margin:0 auto;padding:18px}
    h1{margin:0 0 10px}

    input,select,textarea,button{
      width:100%;
      border-radius:12px;
      border:1px solid #7aa2ff55;
      background:#0f1530;
      color:var(--fg);
      padding:10px;
      margin-top:6px;
    }
    textarea{min-height:220px;white-space:pre;font-family:ui-monospace,Consolas,Menlo,monospace}

    .btn{cursor:pointer;font-weight:700;background:var(--accent);width:auto;display:inline-block;margin-right:8px}

    table{border-collapse:collapse;width:100%;margin-top:12px}
    th,td{border-bottom:1px solid #7aa2ff55;padding:8px;vertical-align:top}
    th{color:var(--mut)}

    tr.unmatched td{background:#51202a}
    tr.duplicate td{background:#58461c}
    tr.unmatched.duplicate td{background:#60313a}

    .legend{display:flex;gap:10px;align-items:center;margin-top:6px;flex-wrap:wrap}
    .chip{display:inline-block;padding:4px 8px;border-radius:999px;border:1px solid #7aa2ff55}
    .chip.unm{background:#51202a}
    .chip.dupl{background:#58461c}

    .toolbar{display:flex;gap:10px;align-items:center;flex-wrap:wrap;margin:8px 0}

    #info{min-height:20px}
    .error{color:#ffa2a2}
    .ok{color:#b5ffbf}

    .modal{position:fixed;inset:0;background:#0008;display:none;align-items:center;justify-content:center;z-index:50}
    .modal>.box{background:#0f1530;border:1px solid #7aa2ff55;border-radius:14px;max-width:900px;width:90%;padding:12px}
    .modal input{width:100%}
    .results{max-height:420px;overflow:auto;margin-top:8px;border:1px solid #7aa2ff33;border-radius:10px}
    .resitem{padding:8px 10px;border-bottom:1px solid #7aa2ff22;cursor:pointer}
    .resitem:hover{background:#15204a}
    .selectWrap{position:relative}
    .selectWrap select{pointer-events:auto}
    .selectCover{position:absolute;inset:0;background:transparent;border:none;border-radius:12px;cursor:pointer}

    /* компактные чекбоксы */
    input[type="checkbox"]{width:14px;height:14px;border-radius:4px;accent-color:#7aa2ff;vertical-align:middle}
    label.inline{display:inline-flex;align-items:center;gap:6px;margin:0}

    /* редактор внизу — details */
    details.editor{margin-top:10px}
    details.editor > summary{cursor:pointer;color:var(--mut,#9fb2ff);list-style:disclosure-closed}
    details.editor[open] > summary{list-style:disclosure-open}

    /* --- фикс: редактор внизу, в одну колонку --- */
    .row{display:block!important}
    #mapCard,.map-card,.right,#rightPane,.rightCol{position:static!important;top:auto!important;width:100%!important;float:none!important;clear:both!important;margin-top:16px!important}
    #mapTable,.map-table,#tbMap{max-height:none!important;overflow:visible!important}
    details.editor{display:block!important;width:100%!important;grid-column:1/-1!important;margin-top:10px!important}

    /* === Компактные ширины === */
    #date{width:100%;max-width:260px}

    /* Комбинированный контрол города */
    .combo{position:relative;width:100%;max-width:560px}
    .combo input{padding-right:34px}
    .combo .arrow{position:absolute;right:10px;top:50%;transform:translateY(-50%);pointer-events:none;opacity:.8}
    .combo-list{
      position:absolute;left:0;right:0;top:calc(100% + 6px);
      background:#0f1530;border:1px solid #7aa2ff55;border-radius:12px;
      max-height:320px;overflow:auto;display:none;z-index:20
    }
    .combo-list.open{display:block}
    .combo-item{padding:8px 10px;border-bottom:1px solid #7aa2ff22;cursor:pointer}
    .combo-item:hover{background:#15204a}

    @media (max-width:720px){
      #date,.combo{max-width:100%}
    }
  
/* ===================== New Year Garland (photoreal, warm white) ===================== */
@keyframes ny-fall{to{transform: translateY(120vh);}}

.ny-stage{
  position:relative;
  max-width: 1500px;
  margin: 0 auto 10px;
  height: 150px;
  z-index:2;
}
.ny-spill{
  position:absolute;
  left:-80px; right:-80px;
  top:0px; height:170px;
  background:
    radial-gradient(900px 140px at 50% 55%, rgba(255,235,190,.18), transparent 68%),
    radial-gradient(760px 120px at 50% 55%, rgba(255,210,140,.09), transparent 68%);
  filter: blur(10px);
  border-radius: 999px;
  opacity: .95;
}
.ny-wireSvg{position:absolute; inset:0; pointer-events:none; z-index:1;}
.ny-wireGlow{fill:none; stroke: rgba(255,240,210,.10); stroke-width:7.5; stroke-linecap:round; filter: blur(2px);}
.ny-wireBase{fill:none; stroke: rgba(0,0,0,.55); stroke-width:3.6; stroke-linecap:round; filter: drop-shadow(0 10px 18px rgba(0,0,0,.55));}
.ny-wireHighlight{fill:none; stroke: rgba(255,255,255,.18); stroke-width:1.4; stroke-linecap:round; opacity:.9;}

.ny-bulbs{position:absolute; inset:0; z-index:2;}
.ny-bulbWrap{
  position:absolute;
  width:28px; height:44px;
  transform-origin: 50% 6px;
  will-change: transform;
}
.ny-drop{
  position:absolute;
  left:50%;
  top:0px;
  width:2px;
  height:8px;
  transform: translateX(-50%);
  background: linear-gradient(180deg, rgba(255,255,255,.22), rgba(255,255,255,.04));
  border-radius: 999px;
  filter: drop-shadow(0 6px 10px rgba(0,0,0,.35));
  opacity:.45;
}
.ny-cap{
  position:absolute;
  left:50%;
  top:8px;
  width:8px; height:5px;
  transform: translateX(-50%);
  border-radius: 2px;
  background: rgba(210,210,210,.28);
  border: 1px solid rgba(255,255,255,.18);
  box-shadow: 0 10px 16px rgba(0,0,0,.25);
}
.ny-bulb{
  position:absolute;
  left:50%;
  top:14px;
  width:12px;
  height:12px;
  transform: translateX(-50%);
  border-radius: 999px;
  background: radial-gradient(circle at 30% 30%,
    rgba(255,247,233,1) 0%,
    rgba(255,236,198,1) 35%,
    rgba(255,214,155,1) 78%,
    rgba(255,192,120,.95) 100%);
  box-shadow:
    0 0 10px rgba(255,230,170,.45),
    0 0 22px rgba(255,220,150,.28),
    0 0 46px rgba(255,210,140,.16);
  border: 1px solid rgba(255,255,255,.35);
}
.ny-bulb::before{
  content:"";
  position:absolute;
  left:2px; top:2px;
  width:4px; height:4px;
  border-radius:999px;
  background: rgba(255,255,255,.68);
  filter: blur(.2px);
  opacity:.85;
}
.ny-bulb::after{
  content:"";
  position:absolute;
  left:50%; top:50%;
  width:52px; height:52px;
  transform: translate(-50%,-50%);
  border-radius:999px;
  background: radial-gradient(circle,
    rgba(255,235,190,.18) 0%,
    rgba(255,220,150,.12) 30%,
    rgba(255,210,140,.06) 52%,
    rgba(255,210,140,0) 72%);
  filter: blur(2px);
  opacity:.9;
  pointer-events:none;
}
@keyframes ny-flicker{
  0%,100%{ filter: brightness(.85); }
  50%{ filter: brightness(1.12); }
}
@keyframes ny-sway{
  0%,100%{ transform: rotate(calc(-1 * var(--ny-sway))) translateY(0px); }
  50%{ transform: rotate(var(--ny-sway)) translateY(1.2px); }
}


/* ===== FIX navbar placement (tabs on the right) ===== */
.navbar{
  position: fixed !important;
  top: 28px !important;
  right: 28px !important;
  left: auto !important;
  display: flex !important;
  flex-direction: column !important;
  gap: 14px !important;
  align-items: flex-end !important;
  z-index: 10000 !important;
  pointer-events: auto !important;
}
.navbar .tab{
  min-width: 240px !important;
}

/* ===== Hide visual scrollbars (keep scrolling) ===== */
*{scrollbar-width:none;}
*::-webkit-scrollbar{width:0;height:0;}
</style>
  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/xlsx-populate/browser/xlsx-populate.min.js"></script>

  <!-- flatpickr: фиксированный формат даты дд.мм.гггг -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
  <script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
  <script src="https://cdn.jsdelivr.net/npm/flatpickr/dist/l10n/ru.js"></script>

  <style>
    /* Tabs navbar */
    .navbar{display:flex;gap:12px;align-items:center;margin:12px 0 16px 0}
    .navbar .tab{appearance:none;border:none;border-radius:999px;padding:10px 16px;font-weight:800;cursor:pointer;
      background:#1b2750;color:#eaf0ff;border:1px solid #7aa2ff55}
    .navbar .tab:hover{background:#2a3a70}
    .navbar .tab.active{background:#3153d3}
    .navbar a{ text-decoration:none }
    /* Sections */
    #ewlSection, #kpiSection{}
    #kpiFrame{width: 100%; min-height: 1100px; border: none; border-radius: 12px; background: #0b1020;}
    #calcFrame{width: 100%; min-height: 500px; border: none; border-radius: 12px; background: #0b1020;}
  </style>

  <style id="tabs-right-overrides">
    /* Dock the tab bar on the right */
    .navbar{
      position: fixed;
      top: 20px;
      right: 20px;
      display: flex;
      flex-direction: column;
      gap: 12px;
      width: 260px;
      z-index: 50;
      background: transparent;
      padding: 0;
    }
    .navbar .tab{
      width: 100%;
      text-align: center;
      border-radius: 999px;
    }
    /* Push main sections so they don't hide under the sidebar */
    #ewlSection, #kpiSection, #calcSection{
      margin-right: 300px; /* sidebar width + spacing */
    }
    /* Make iframes adapt in width */
    #kpiFrame, #calcFrame{ width: 100%; }
    /* Responsive: on small screens fallback to top bar */
    @media (max-width: 980px){
      .navbar{
        position: static;
        flex-direction: row;
        width: auto;
        margin: 0 16px 12px;
      }
      #ewlSection, #kpiSection, #calcSection{
        margin-right: 0;
      }
    }
  
/* ================== FORCE near-black night theme (override) ================== */
html, body{
  background: radial-gradient(1200px 420px at 50% 0%, rgba(255,226,163,.06), transparent 62%),
              radial-gradient(900px 360px at 80% 10%, rgba(255,214,138,.04), transparent 60%),
              radial-gradient(900px 520px at 20% 0%, rgba(120,170,255,.04), transparent 60%),
              linear-gradient(180deg, #01020a 0%, #020412 40%, #03061a 100%) !important;
  color: #eaf2ff;
}

/* If there is a main background wrapper, keep it transparent so body shows through */
body > .container,
body > .app,
body > .page,
#app,
#root,
.main,
.wrapper{
  background: transparent !important;
}

/* Primary panel/card surfaces */
.container, .card, .panel, .box, .content, .main-content, .left-panel{
  background: rgba(15,23,42,.82) !important;
  border-color: rgba(148,163,184,.22) !important;
  color:#eaf2ff !important;
}

/* Inputs */
input, textarea, select{
  background: rgba(7,11,20,.78) !important;
  color:#eaf2ff !important;
  border-color: rgba(148,163,184,.22) !important;
}

/* Tabs/buttons */
button, .btn, .tab, .nav-btn{
  color:#eaf2ff !important;
}

/* Reduce any legacy light theme body backgrounds */
.light, .theme-light{
  background: transparent !important;
}


/* ===== Night near-black background ===== */
html, body{
  background:
    radial-gradient(1200px 420px at 50% 0%, rgba(255,226,163,.06), transparent 62%),
    radial-gradient(900px 360px at 80% 10%, rgba(255,214,138,.04), transparent 60%),
    radial-gradient(900px 520px at 20% 0%, rgba(120,170,255,.04), transparent 60%),
    linear-gradient(180deg, #01020a 0%, #020412 40%, #03061a 100%) !important;
  color:#eaf2ff;
}

/* Frosted buttons */
button, .btn, .tab{
  background: linear-gradient(180deg, rgba(255,255,255,.14), rgba(255,255,255,.04)) !important;
  border: 1px solid rgba(255,255,255,.28) !important;
  color:#f1f5ff !important;
  box-shadow: inset 0 1px 0 rgba(255,255,255,.22), 0 10px 28px rgba(0,0,0,.55) !important;
  backdrop-filter: blur(8px);
  -webkit-backdrop-filter: blur(8px);
}
button:hover, .btn:hover, .tab:hover{
  background: linear-gradient(180deg, rgba(255,255,255,.22), rgba(255,255,255,.08)) !important;
}
.tab.active{
  border-color: rgba(255,220,160,.65) !important;
  box-shadow: 0 0 24px rgba(255,200,140,.35), 0 12px 28px rgba(0,0,0,.6) !important;
}



/* ================== KPI THEME ALIGNMENT ================== */
#kpiSection, #kpiTab, .kpi-section, .kpiTab, .kpi-page, .kpi-root {
  background: transparent !important;
}

#kpiSection .container, #kpiSection .card, #kpiSection .panel, #kpiSection .kpi-card,
.kpi-section .container, .kpi-section .card, .kpi-section .panel, .kpi-card {
  background: rgba(15,23,42,.82) !important;
  border: 1px solid rgba(148,163,184,.22) !important;
  color: #eaf2ff !important;
  box-shadow: 0 22px 60px rgba(0,0,0,.55) !important;
  border-radius: 18px !important;
}

#kpiSection h1, #kpiSection h2, #kpiSection h3, .kpi-section h1, .kpi-section h2, .kpi-section h3{
  color:#eaf2ff !important;
}
#kpiSection .muted, .kpi-section .muted, #kpiSection small, .kpi-section small{
  color:#b6c6ff !important;
}

#kpiSection input, #kpiSection textarea, #kpiSection select,
.kpi-section input, .kpi-section textarea, .kpi-section select{
  background: rgba(7,11,20,.78) !important;
  color:#eaf2ff !important;
  border-color: rgba(148,163,184,.22) !important;
}

/* Ensure same near-black background always shows through */
html, body{
  background: radial-gradient(1200px 420px at 50% 0%, rgba(255,226,163,.06), transparent 62%),
              radial-gradient(900px 360px at 80% 10%, rgba(255,214,138,.04), transparent 60%),
              radial-gradient(900px 520px at 20% 0%, rgba(120,170,255,.04), transparent 60%),
              linear-gradient(180deg, #01020a 0%, #020412 40%, #03061a 100%) !important;
}




button::before,
.btn::before,
.nav-btn::before {
  content: "";
  position: absolute;
  top: -6px;
  left: -10%;
  width: 120%;
  height: 16px;
  background:
    radial-gradient(14px 8px at 10% 100%, rgba(255,255,255,.95) 60%, transparent 70%),
    radial-gradient(18px 10px at 30% 100%, rgba(255,255,255,.92) 60%, transparent 72%),
    radial-gradient(16px 9px at 55% 100%, rgba(255,255,255,.96) 60%, transparent 70%),
    radial-gradient(20px 11px at 80% 100%, rgba(255,255,255,.9) 60%, transparent 72%);
  filter:
    drop-shadow(0 2px 3px rgba(0,0,0,.35))
    drop-shadow(0 0 6px rgba(255,255,255,.35));
  opacity: .85;
  pointer-events: none;
}

button:hover::before,
.btn:hover::before,
.nav-btn:hover::before {
  transform: translateY(2px);
  opacity: .7;
}

button:active::before,
.btn:active::before,
.nav-btn:active::before {
  transform: translateY(4px) scaleY(.85);
  opacity: .6;
}




/* slight settling on hover */
button:hover::after,
.btn:hover::after,
.nav-btn:hover::after {
  transform: translateY(2px);
  opacity: .8;
}

/* pressed – snow shifts a bit */
button:active::after,
.btn:active::after,
.nav-btn:active::after {
  transform: translateY(4px) scaleY(.9);
  opacity: .7;
}




/* IMPORTANT: the snow must not overlap the button content area.
   We place the snow blob entirely ABOVE the top edge: top = -H, height = H, so its bottom sits exactly at 0. */
button, .btn, .nav-btn{
  position: relative;
  overflow: visible !important;
}

/* snow cap */
button::after, .btn::after, .nav-btn::after{
  content:"";
  position:absolute;
  left:-10%;
  width:120%;
  height:26px;          /* H */
  top:-26px;            /* -H => NO overlap into button */
  pointer-events:none;
  z-index: 5;

  /* One coherent snow "blob" + irregular bottom edge */
  background:
    radial-gradient(22px 14px at 10% 100%, rgba(255,255,255,.96) 64%, transparent 72%),
    radial-gradient(28px 16px at 30% 100%, rgba(255,255,255,.92) 62%, transparent 74%),
    radial-gradient(24px 15px at 54% 100%, rgba(255,255,255,.97) 64%, transparent 73%),
    radial-gradient(30px 17px at 78% 100%, rgba(255,255,255,.90) 62%, transparent 75%),
    radial-gradient(20px 13px at 94% 100%, rgba(255,255,255,.95) 64%, transparent 72%),
    linear-gradient(to bottom, rgba(255,255,255,.92), rgba(255,255,255,.86)); /* fills gaps so it isn't "eggs" */

  /* soften and seat it on top */
  border-radius: 999px 999px 14px 14px;
  filter:
    drop-shadow(0 4px 6px rgba(0,0,0,.45))
    drop-shadow(0 0 10px rgba(255,255,255,.28));
  opacity:.92;
}

/* subtle interaction: snow "settles" (still stays outside) */
button:hover::after, .btn:hover::after, .nav-btn:hover::after{
  transform: translateY(2px); /* still above; bottom becomes slightly below 0 by 2px, acceptable */
  opacity:.85;
}
button:active::after, .btn:active::after, .nav-btn:active::after{
  transform: translateY(4px) scaleY(.92);
  opacity:.78;
}




/* Apply only when button has class . */
button., .btn., .nav-btn.{
  position: relative;
  overflow: visible !important;
}

/* Subtle snow ridge sitting on top edge (does NOT cover button face) */
button.::after,
.btn.::after,
.nav-btn.::after{
  content:"";
  position:absolute;
  left:-4%;
  width:108%;
  height:12px;      /* H */
  top:-12px;        /* -H => stays outside */
  pointer-events:none;
  z-index: 3;
  opacity:.55;

  /* soft uneven ridge + tiny clumps (no big semicircles) */
  background:
    radial-gradient(10px 6px at 8% 100%, rgba(255,255,255,.90) 62%, transparent 72%),
    radial-gradient(14px 7px at 28% 100%, rgba(255,255,255,.86) 60%, transparent 74%),
    radial-gradient(12px 7px at 52% 100%, rgba(255,255,255,.92) 62%, transparent 73%),
    radial-gradient(16px 8px at 76% 100%, rgba(255,255,255,.84) 60%, transparent 75%),
    radial-gradient(10px 6px at 94% 100%, rgba(255,255,255,.88) 62%, transparent 72%),
    linear-gradient(to bottom, rgba(255,255,255,.72), rgba(255,255,255,.56));

  border-radius: 999px 999px 10px 10px;
  filter:
    drop-shadow(0 2px 3px rgba(0,0,0,.40))
    drop-shadow(0 0 6px rgba(255,255,255,.20));
}

/* A tiny "frost edge" on the top border (very subtle) */
button.::before,
.btn.::before,
.nav-btn.::before{
  content:"";
  position:absolute;
  left:10%;
  width:80%;
  height:2px;
  top:-1px;
  pointer-events:none;
  background: linear-gradient(90deg, transparent, rgba(255,255,255,.22), transparent);
  opacity:.55;
  filter: blur(.2px);
}




/* Use on .nav-btn and buttons marked with [] */
.nav-btn, button[], .btn[]{
  position: relative;
  overflow: visible !important;
}

.nav-btn::after,
button[]::after,
.btn[]::after{
  content:"";
  position:absolute;
  left:12%;
  width:76%;
  top:-2px;
  height:6px;
  pointer-events:none;
  border-radius: 999px;
  background: linear-gradient(180deg,
    rgba(255,255,255,.28),
    rgba(255,255,255,.10),
    rgba(255,255,255,0));
  filter: blur(.2px) drop-shadow(0 2px 3px rgba(0,0,0,.35));
  opacity:.55;
}

.nav-btn::before,
button[]::before,
.btn[]::before{
  content:"";
  position:absolute;
  left:18%;
  width:64%;
  top:-1px;
  height:2px;
  pointer-events:none;
  border-radius:999px;
  background: linear-gradient(90deg, transparent, rgba(255,255,255,.22), transparent);
  opacity:.45;
  filter: blur(.3px);
}




/* thin icy highlight exactly on the top border */
.nav-btn::before,
button[]::before,
.btn[]::before{
  content:"";
  position:absolute;
  left:10%;
  width:80%;
  top:-1px;
  height:2px;
  pointer-events:none;
  border-radius:999px;
  background: linear-gradient(90deg, transparent, rgba(255,255,255,.22), transparent);
  opacity:.35;
  filter: blur(.35px);
}

/* subtle irregular frost dust ABOVE the border (very low height, few clumps) */
.nav-btn::after,
button[]::after,
.btn[]::after{
  content:"";
  position:absolute;
  left:8%;
  width:84%;
  top:-6px;
  height:6px;
  pointer-events:none;
  border-radius: 999px;
  opacity:.32;
  background:
    linear-gradient(to bottom, rgba(255,255,255,.18), rgba(255,255,255,0)),
    radial-gradient(8px 4px at 18% 90%, rgba(255,255,255,.28) 60%, transparent 72%),
    radial-gradient(10px 5px at 54% 95%, rgba(255,255,255,.24) 60%, transparent 74%),
    radial-gradient(7px 4px at 86% 88%, rgba(255,255,255,.26) 60%, transparent 72%);
  filter: drop-shadow(0 2px 3px rgba(0,0,0,.35));
}



/* ================== DISABLE button "snow caps" / pseudo decorations ================== */
button::before, button::after,
.btn::before, .btn::after,
.nav-btn::before, .nav-btn::after{
  content: none !important;
  display: none !important;
}


/* ================== FALLING SNOW (BACKGROUND) ================== */
.snow{
  position: fixed;
  inset: 0;
  pointer-events: none;
  z-index: 0; /* behind UI */
  opacity: .75;
}
.snow i{
  position: absolute;
  top: -12vh;
  width: 2.2px;
  height: 2.2px;
  border-radius: 50%;
  background: rgba(255,255,255,.90);
  filter: drop-shadow(0 0 8px rgba(255,255,255,.28));
  animation: fall linear infinite;
}
@keyframes fall{
  to{ transform: translateY(120vh); }
}



/* Keep UI above background snow */
.stage, .navbar, .tabs, .right-nav, .container, .card, .panel, #app, #root, .main, .wrapper{
  position: relative;
  z-index: 2;
}



/* ================== RIGHT NAV RESTORE ================== */
.right-nav, .nav-buttons, .sidebar, .nav, .tabs-right, .top-buttons{
  position: fixed !important;
  top: 34px !important;
  right: 34px !important;
  left: auto !important;
  z-index: 9999 !important;
  display: flex !important;
  flex-direction: column !important;
  gap: 14px !important;
  align-items: flex-end !important;
}
.right-nav button, .nav-buttons button, .sidebar button, .nav button, .tabs-right button, .top-buttons button,
.right-nav .nav-btn, .nav-buttons .nav-btn, .sidebar .nav-btn, .nav .nav-btn{
  min-width: 240px;
}



/* ================== SCROLLBAR HIDE (VISUAL) ================== */
/* Hide page scrollbar while keeping scrolling working */
html, body{
  scrollbar-width: none; /* Firefox */
}
html::-webkit-scrollbar, body::-webkit-scrollbar{
  width: 0; height: 0;
}
/* Hide iframe scrollbar visual if any */
iframe{
  scrollbar-width: none;
}
iframe::-webkit-scrollbar{
  width: 0; height: 0;
}



/* ================== FIX: mapping blocks look blurred ================== */
/* Make mapping table controls crisp (no frosted/backdrop blur on text) */
#tbMap input, #tbMap select, #tbMap textarea,
#mapEditor input, #mapEditor select, #mapEditor textarea{
  filter: none !important;
  backdrop-filter: none !important;
  -webkit-backdrop-filter: none !important;
  text-shadow: none !important;
  opacity: 1 !important;
  background: rgba(8,12,22,.92) !important;
  border-color: rgba(148,163,184,.28) !important;
}

/* If the catalog match field is rendered as a "pill"/div, keep it crisp too */
#tbMap .pill, #tbMap .match, #tbMap .catalog, #tbMap .val, #tbMap .key{
  filter: none !important;
  backdrop-filter: none !important;
  -webkit-backdrop-filter: none !important;
}



/* ================== FIX v2: remove blur from mapping "catalog match" field ================== */
#tbMap td, #tbMap th,
#tbMap td *, #tbMap th *,
#tbMap .cell, #tbMap .field, #tbMap .input, #tbMap .select, #tbMap .control,
#tbMap .match, #tbMap .catalog, #tbMap .mapped, #tbMap .mappedField,
#tbMap [contenteditable="true"],
#tbMap [role="textbox"]{
  filter: none !important;
  backdrop-filter: none !important;
  -webkit-backdrop-filter: none !important;
  text-shadow: none !important;
  -webkit-text-stroke: 0 transparent !important;
}

/* Specifically ensure the second column "Соответствие (каталог)" looks crisp */
#tbMap td:nth-child(2){
  backdrop-filter: none !important;
  -webkit-backdrop-filter: none !important;
}
#tbMap td:nth-child(2) > *{
  background: rgba(8,12,22,.92) !important;
  border: 1px solid rgba(148,163,184,.28) !important;
  border-radius: 12px !important;
}

/* If the blur is coming from a ::before/::after glass layer, disable those too */
#tbMap td:nth-child(2)::before, #tbMap td:nth-child(2)::after,
#tbMap td:nth-child(2) > *::before, #tbMap td:nth-child(2) > *::after{
  content: none !important;
  display: none !important;
}

/* Keep dropdown list readable */
#tbMap option{
  background: #0b1224 !important;
  color: #eaf2ff !important;
}

</style>

</head>
<body>
  <div class="snow" id="snow" aria-hidden="true"></div>
  
  
<div class="ny-stage" aria-hidden="true">
  <div class="ny-spill"></div>
  <svg class="ny-wireSvg" viewBox="0 0 1500 150" preserveAspectRatio="none" aria-hidden="true">
    <path class="ny-wireGlow" id="ny-wireGlow" d=""></path>
    <path class="ny-wireBase" id="ny-wireBase" d=""></path>
    <path class="ny-wireHighlight" id="ny-wireHighlight" d=""></path>
  </svg>
  <div class="ny-bulbs" id="ny-bulbs"></div>
</div>

  <div class="navbar">
    <button class="tab active" id="tabEWL" type="button">EWL Order</button>
    <button class="tab" id="tabKPI" type="button">KPI</button>
</div>

  <!-- EWL Order original content -->
  <div id="ewlSection">

  <div class="card">
    <h1>EWL Order</h1>

    <!-- Ввод и управление -->
    <div>
      <label>Загрузи шаблон бланка ИВЛ
        <input type="file" id="tmpl" accept=".xlsx,application/vnd.openxmlformats-officedocument.spreadsheetml.sheet">
      </label>
      <div class="inline-controls" style="margin-top:8px">
        <button class="btn" id="remember">Запомнить шаблон</button>
        <button class="btn" id="clearStored">Забыть</button>
        <span id="storedInfo" class="muted"></span>
      </div>

      <div class="inline-controls" style="margin-top:12px;gap:14px;align-items:flex-start;flex-wrap:wrap">
        <label>Дата
          <!-- Было: <input type="date" id="date"> -->
          <input type="text" id="date" placeholder="дд.мм.гггг" inputmode="numeric" autocomplete="off">
        </label>
      </div>

      <label style="flex:1 1 560px;display:block;margin-top:12px">Ресторан
        <div class="combo" id="cityComboBox">
          <input id="cityCombo" placeholder="Начните ввод…">
          <svg class="arrow" width="16" height="16" viewBox="0 0 24 24">
            <path fill="currentColor" d="M7 10l5 5 5-5z"/>
          </svg>
          <div class="combo-list" id="cityList"></div>
        </div>
      </label>


      <label style="margin-top:14px">Текст заказа
        <textarea id="order" placeholder="Вставьте заказ сюда..."></textarea>
      </label>
      <button class="btn" id="clearOrder" style="margin-top:6px">Очистить текст</button>


      <div class="toolbar">
        <button class="btn" id="preview">Предпросмотр</button>
        <button class="btn" id="download">Скачать Excel</button>
        <label class="inline"><input type="checkbox" id="hideMatched"> Скрывать совпавшие</label>
        <label class="inline"><input type="checkbox" id="onlyProblems"> Только проблемные</label>
      </div>

      <div class="legend">
        <span class="chip unm">не найдено</span>
        <span class="chip dupl">повтор</span>
        <span id="statMatched" class="muted">Совпадений: 0 / 0</span>
        <span id="statTotal" class="muted">Итого заказано единиц: 0</span>
      </div>

      <div id="info" style="margin-top:6px"></div>

      <table>
        <thead><tr><th>Наименование (из заказа)</th><th>Соответствие (каталог)</th><th>Кол-во</th></tr></thead>
        <tbody id="tbMap"></tbody>
      </table>
    </div>

    <!-- Редактор соответствий внизу -->
    <details class="editor" id="mapEditor">
      <summary>Редактор соответствий (память)</summary>
      <div style="margin-top:10px">
        <div style="margin-bottom:8px;display:flex;gap:10px;flex-wrap:wrap">
          <button id="exportMap" class="btn">Экспорт JSON</button>
          <button id="importMap" class="btn">Импорт JSON</button>
          <input id="importMapFile" type="file" accept=".json" style="display:none">
          <button id="clearMap" class="btn">Очистить</button>
        </div>
        <table id="mapTable">
          <thead>
            <tr>
              <th>Ключ (из заказа)</th>
              <th>Значение (каталог / #ROW:n)</th>
              <th></th>
            </tr>
          </thead>
          <tbody id="mapBody"></tbody>
        </table>
      </div>
    </details>
  </div>

  <!-- Модальная лупа по каталогу -->
  <div class="modal" id="picker">
    <div class="box">
      <div style="display:flex;gap:8px;align-items:center">
        <input id="pickerQuery" placeholder="Ищите по подстроке…">
        <button class="btn" id="pickerClose" style="margin:0">Закрыть</button>
      </div>
      <div class="results" id="pickerResults"></div>
    </div>
  </div>

<script>
/* ====================== БАЗОВЫЕ УТИЛЫ ====================== */
const LS_KEY='ewl_map_v2';
function norm(s){return String(s||'').toLowerCase().replace(/[ё]/g,'е').replace(/["'`]/g,'').replace(/\s+/g,' ').trim();}

function loadMemory(){try{const raw=localStorage.getItem(LS_KEY);if(!raw) return {version:2,map:{}};const data=JSON.parse(raw);if(!data.map) return {version:2,map:{}};return {version:2,map:data.map};}catch{return {version:2,map:{}}}}
function saveMemory(obj){localStorage.setItem(LS_KEY, JSON.stringify(obj));}
function rememberMatch(srcText, templText){const mem=loadMemory();mem.map[norm(srcText)]=norm(templText);saveMemory(mem);}
function forgetMatch(srcText){const mem=loadMemory();delete mem.map[norm(srcText)];saveMemory(mem);}

function parseOrder(text){
  const lines=String(text||'').split(/\r?\n/);let start=0;
  for(let i=0;i<lines.length;i++){ if(/наименован/i.test(lines[i])){start=i+1;break;} }
  const out=[];
  for(let i=start;i<lines.length;i++){
    const line=lines[i].trim(); if(!line) continue;
    const m=line.match(/(.+?)\s+(-?\d+(?:[.,]\d+)?)\s*$/);
    if(m){ out.push([m[1].trim(), parseFloat(m[2].replace(',', '.'))]); }
  }
  return out;
}
function setInfo(msg,isErr=false){const box=document.getElementById('info'); if(!box) return; box.innerHTML=isErr?`<span class="error">${msg}</span>`:`<span class="ok">${msg}</span>`;}

/* ================= IndexedDB и кэш ================= */
const DB='ewl_order_prod_db', STORE='kv', KEY_BUF='template_buf', KEY_NAME='template_name', KEY_CITIES='cities_cache_v1';
function idb(){return new Promise((res,rej)=>{const r=indexedDB.open(DB,1);r.onupgradeneeded=()=>r.result.createObjectStore(STORE);r.onsuccess=()=>res(r.result);r.onerror=()=>rej(r.error);});}
async function getKV(k){const d=await idb();return new Promise((res,rej)=>{const tx=d.transaction(STORE,'readonly'),st=tx.objectStore(STORE),r=st.get(k);r.onsuccess=()=>res(r.result||null);r.onerror=()=>rej(r.error);});}
async function setKV(k,v){const d=await idb();return new Promise((res,rej)=>{const tx=d.transaction(STORE,'readwrite'),st=tx.objectStore(STORE),r=st.put(v,k);r.onsuccess=()=>res();r.onerror=()=>rej(r.error);});}
async function delKV(k){const d=await idb();return new Promise((res,rej)=>{const tx=d.transaction(STORE,'readwrite'),st=tx.objectStore(STORE),r=st.delete(k);r.onsuccess=()=>res();r.onerror=()=>rej(r.error);});}

/* ======= Глобальные ======= */
let catalog=[];       // [{r,text,norm}]
let assignments=[];   // [{src,qty,destR}]
let lastRows=[];      // [[src,qty]...]
let rowMetas=[];      // [{tr,sel,isDup}...]

let citiesArray=[];         // [{code,name}]
let citySelected='';        // строка выбранного города

/* ======= Комбинированный контрол города ======= */
const cityCombo = document.getElementById('cityCombo');
const cityList  = document.getElementById('cityList');
const cityBox   = document.getElementById('cityComboBox');

function renderCityList(filter=''){
  const q = norm(filter);
  const list = citiesArray
    .filter(c => !q || norm(c.name).includes(q))
    .map(c => `<div class="combo-item" data-name="${c.name.replace(/"/g,'&quot;')}">${c.name}</div>`)
    .join('') || '<div class="combo-item" style="pointer-events:none;opacity:.6">Ничего не найдено</div>';
  cityList.innerHTML = list;
  for(const it of cityList.querySelectorAll('.combo-item[data-name]')){
    it.onclick = () => { citySelected = it.dataset.name; cityCombo.value = citySelected; cityList.classList.remove('open'); };
  }
}

function openCityList(){ renderCityList(cityCombo.value); cityList.classList.add('open'); }
function closeCityList(){ cityList.classList.remove('open'); }

cityCombo.addEventListener('focus', openCityList);
cityCombo.addEventListener('input', ()=>{ openCityList(); });
cityCombo.addEventListener('keydown', (e)=>{
  if(e.key==='Enter'){
    const first=cityList.querySelector('.combo-item[data-name]'); 
    if(first){ first.click(); e.preventDefault(); }
  }
});
document.addEventListener('click', (e)=>{
  if(!cityBox.contains(e.target)) closeCityList();
});
cityBox.addEventListener('click', ()=>{
  if(cityList.classList.contains('open')) closeCityList(); else openCityList();
});

/* ---- загрузка/сохранение городов ---- */
async function getCachedCities(){ try { return await getKV(KEY_CITIES); } catch { return null; } }
async function setCachedCities(cities){ try { await setKV(KEY_CITIES, cities); } catch {} }

/* ================= Автозагрузка при старте ================= */
(async()=>{
  try{
    const buf  = await getKV(KEY_BUF);
    const name = await getKV(KEY_NAME);
    if(buf){ window.templateBuf=buf; window.templateName=name||'(запомненный)'; const storedInfo=document.getElementById('storedInfo'); if(storedInfo) storedInfo.textContent='Шаблон: '+window.templateName; }

    const cachedCities = await getCachedCities();
    if(cachedCities && cachedCities.length){
      citiesArray = cachedCities;
      renderCityList('');
    }
    renderMapEditor();
  }catch(e){ setInfo('IndexedDB недоступен (шаблон/справочник не будут запоминаться)',true); }
})();

/* ================= Кнопки "Запомнить/Забыть шаблон" ================= */
document.getElementById('remember').onclick=async()=>{
  const f=document.getElementById('tmpl').files[0];
  if(!f){ setInfo('Выберите .xlsx',true); return; }
  const buf=await f.arrayBuffer(); await setKV(KEY_BUF,buf); await setKV(KEY_NAME,f.name);
  window.templateBuf=buf; window.templateName=f.name;
  const storedInfo=document.getElementById('storedInfo'); if(storedInfo) storedInfo.textContent='Шаблон: '+f.name;
  setInfo('Шаблон запомнен');
  if(citiesArray && citiesArray.length){ await setCachedCities(citiesArray); renderCityList(''); }
};

document.getElementById('clearStored').onclick=async()=>{
  await delKV(KEY_BUF); await delKV(KEY_NAME); window.templateBuf=null; window.templateName=null;
  const storedInfo=document.getElementById('storedInfo'); if(storedInfo) storedInfo.textContent='';
  setInfo('Шаблон забыли');
};

/* ------------------- чтение шаблона ------------------- */
async function readCatalogAndL1(){
  const f=document.getElementById('tmpl').files[0];
  const buf = f?await f.arrayBuffer():(window.templateBuf||await getKV(KEY_BUF));
  if(!buf) throw new Error('Нет шаблона');

  const wb = XLSX.read(buf,{type:'array',cellText:true,cellDates:true,cellNF:true});
  const order=wb.Sheets['Order']; if(!order) throw new Error('Нет листа Order');

  const ref=order['!ref']||'A1'; const range=XLSX.utils.decode_range(ref);
  const list=[];
  for(let r=14;r<=range.e.r+1;r++){
    const addr=XLSX.utils.encode_cell({c:3,r:r-1}); // D
    const cell=order[addr];
    if(!cell) continue;
    const text=(cell.w!=null?String(cell.w):(cell.v!=null?String(cell.v):'')).trim();
    if(text) list.push({r,text,norm:norm(text)});
  }
  catalog=list;

  const l1=wb.Sheets['L1'];
  if(l1){
    const rows=XLSX.utils.sheet_to_json(l1,{header:1,defval:''});
    const arr=[];
    for(let i=1;i<rows.length;i++){
      const code=String(rows[i][1]??'').trim();
      const city=String(rows[i][2]??'').trim();
      if(city) arr.push({code,name:city});
    }
    if(arr.length){
      citiesArray=arr; renderCityList('');
      await setCachedCities(arr);
    }
  }
  return buf;
}

/* ====== индексы/автосопоставление ====== */
function buildTemplateIndex(){const idx=new Map(); for(const c of catalog){ idx.set(c.norm,c.r);} return idx;}
function autoMatchByIncludes(userTextNorm){
  let hit=catalog.find(c=>c.norm.includes(userTextNorm)||userTextNorm.includes(c.norm));
  if(hit) return hit.r;
  const terms=userTextNorm.split(' ').filter(Boolean);
  hit=catalog.find(c=>terms.every(t=>c.norm.includes(t)));
  return hit?hit.r:null;
}

function updateStats(){
  const total=lastRows.reduce((s,[,q])=>s+Number(q||0),0);
  const matched=assignments.reduce((s,a)=>s+(a.destR!=null?1:0),0);
  document.getElementById('statMatched').textContent=`Совпадений: ${matched} / ${lastRows.length}`;
  document.getElementById('statTotal').textContent=`Итого заказано единиц: ${total}`;
}

/* ====== модальная лупа по каталогу ====== */
const picker=document.getElementById('picker');
const pickerQuery=document.getElementById('pickerQuery');
const pickerResults=document.getElementById('pickerResults');
const pickerClose=document.getElementById('pickerClose');

pickerQuery.addEventListener('input',e=>renderPickerResults(e.target.value));
pickerQuery.addEventListener('keydown',e=>{
  if(e.key==='Enter'){const first=pickerResults.querySelector('.resitem[data-r]'); if(first){first.click(); e.preventDefault();}}
});
let activePickerSel=null;
function openPicker(forSelect){activePickerSel=forSelect; picker.style.display='flex'; pickerQuery.value=''; renderPickerResults(''); pickerQuery.focus();}
function closePicker(){picker.style.display='none'; activePickerSel=null;}
pickerClose.onclick=closePicker; picker.addEventListener('click',e=>{if(e.target===picker) closePicker();});
window.addEventListener('keydown',e=>{if(e.key==='Escape') closePicker();});

function renderPickerResults(q){
  const terms=norm(q).split(' ').filter(Boolean);
  const filtered=catalog.filter(c=>terms.every(t=>c.norm.includes(t)));
  pickerResults.innerHTML = filtered.map(c=>`<div class="resitem" data-r="${c.r}">${c.text.replace(/</g,'&lt;').replace(/>/g,'&gt;')}</div>`).join('') || '<div class="resitem">Ничего не найдено</div>';
  for(const div of pickerResults.querySelectorAll('.resitem[data-r]')){
    div.onclick=()=>{ if(activePickerSel){ activePickerSel.value=div.dataset.r; activePickerSel.dispatchEvent(new Event('change')); } closePicker(); };
  }
}

/* фильтры по строке справа */
const optionFilter=document.getElementById('optionFilter');
if (optionFilter) {
  optionFilter.addEventListener('input', ()=>{
    const f=norm(optionFilter.value);
    for(const m of rowMetas) rebuildOptions(m.sel, f);
  });
}

function rebuildOptions(sel,filter){
  const keep=sel.value;
  sel.innerHTML='<option value="">— выберите —</option>' + catalog.filter(c=>!filter||c.norm.includes(filter)).map(c=>`<option value="${c.r}">${c.text.replace(/</g,'&lt;').replace(/>/g,'&gt;')}</option>`).join('');
  if(keep && [...sel.options].some(o=>o.value===String(keep))) sel.value=String(keep);
}

function applyRowFlags(tr,unmatched,dup){tr.classList.toggle('unmatched',!!unmatched); tr.classList.toggle('duplicate',!!dup);}
function applyFilters(){
  const hide=document.getElementById('hideMatched').checked, prob=document.getElementById('onlyProblems').checked;
  for(const m of rowMetas){
    const r=m.sel.value?parseInt(m.sel.value,10):null;
    const unmatched=(r==null), dup=m.isDup;
    let show=true; if(hide && !unmatched) show=false; if(prob && !(unmatched||dup)) show=false;
    m.tr.style.display=show?'':'none';
  }
}
document.getElementById('hideMatched').addEventListener('change',applyFilters);
document.getElementById('onlyProblems').addEventListener('change',applyFilters);

/* постройка таблицы */
function buildTable(rows){
  const tbMap=document.getElementById('tbMap'); tbMap.innerHTML=''; assignments=[]; lastRows=rows; rowMetas=[];
  const counts=new Map(); for(const [s] of rows){const k=norm(s); counts.set(k,(counts.get(k)||0)+1);}

  const mem=loadMemory(); const templateIdx=buildTemplateIndex();

  for(const [src,qty] of rows){
    const tr=document.createElement('tr');
    const wrap=document.createElement('div'); wrap.className='selectWrap';
    const sel=document.createElement('select'); sel.innerHTML='';
    const cover=document.createElement('button'); cover.type='button'; cover.className='selectCover'; cover.title='Поиск';
    wrap.appendChild(sel); wrap.appendChild(cover);
    tr.innerHTML=`<td class="warn"></td><td></td><td>${qty}</td>`;
    tr.children[0].textContent=src;
    tr.children[1].appendChild(wrap);
    tbMap.appendChild(tr);
    rebuildOptions(sel,'');

    cover.addEventListener('click',()=>openPicker(sel));

    const key=norm(src);
    let preR=null;
    const savedTemplNorm=mem.map[key];
    if(savedTemplNorm){
      if(savedTemplNorm.startsWith('#ROW:')){
        const row=parseInt(savedTemplNorm.slice(5),10); if(Number.isFinite(row)) preR=row;
      } else { const row=templateIdx.get(savedTemplNorm); if(row) preR=row; }
    } else { preR=autoMatchByIncludes(key); }
    if(preR) sel.value=String(preR);

    const isDup=(counts.get(key)||0)>1;
    function upd(){
      const r=sel.value?parseInt(sel.value,10):null;
      const idx=assignments.findIndex(a=>a.src===src);
      if(idx>=0) assignments[idx]={src,qty,destR:r}; else assignments.push({src,qty,destR:r});
      if(r!=null){ const chosen=catalog.find(c=>c.r===r); if(chosen) rememberMatch(src,chosen.text); } else { forgetMatch(src); }
      applyRowFlags(tr,r==null,isDup); applyFilters(); updateStats();
    }
    sel.addEventListener('change',upd);
    rowMetas.push({tr,sel,isDup});
    applyRowFlags(tr,preR==null,isDup); upd();
  }
}

/* Предпросмотр */
document.getElementById('preview').onclick=async()=>{
  try{
    setInfo(''); await readCatalogAndL1();
    const rows=parseOrder(document.getElementById('order').value);
    buildTable(rows);
    setInfo(`Каталог загружен: ${catalog.length} позиций.`);
  }catch(e){ setInfo(e.message,true); }
};

/* Cкачивание Excel */
function safeFilename(s){return s.replace(/[\\/:*?"<>|]+/g,' ').replace(/\s{2,}/g,' ').trim();}
function buildFilename(){
  const city = citySelected || (citiesArray[0]?.name || 'EWL_Order');
  const dt = document.getElementById('date').value?.trim();
  let ddmm='дата';
  const m = /^(\d{2})\.(\d{2})\.(\d{4})$/.exec(dt || '');
  if (m) {
    const [, dd, mm, yyyy] = m;
    ddmm = `${dd}.${mm}.${yyyy}`;
  }
  return `${city} ${ddmm}.xlsx`;
}
document.getElementById('download').onclick=async()=>{
  try{
    setInfo('');
    const buf=await readCatalogAndL1();
    const wb=await XlsxPopulate.fromDataAsync(buf);
    const order=wb.sheet('Order'); const l1=wb.sheet('L1');

    const city = citySelected || (citiesArray[0]?.name || '');
    let code='';
    if(l1){
      const end=l1.usedRange().endCell().rowNumber();
      const nrm=s=>String(s??'').toLowerCase().trim();
      for(let r=2;r<=end;r++){
        const b=l1.cell(r,2).value(), c=l1.cell(r,3).value();
        if(nrm(c)===nrm(city)){ code=(typeof b==='number')?String(Math.trunc(b)):String(b??''); break; }
      }
    }
    const merged = (code && city) ? `${code} - ${city}` : (city || code || '');
    order.cell('D2').value(merged);

    const dt = document.getElementById('date').value?.trim();
    const md = /^(\d{2})\.(\d{2})\.(\d{4})$/.exec(dt || '');
    if (md) {
      const [, dd, mm, yyyy] = md;
      order.cell('D8').value(`${dd}.${mm}.${yyyy}`);
    }

    const endRow=order.usedRange().endCell().rowNumber();
    for(let r=14;r<=endRow;r++) order.cell(r,6).value(null);
    let written=0; for(const a of assignments){ if(a.destR!=null && a.destR>=14 && a.destR<=endRow){ order.cell(a.destR,6).value(a.qty); written++; } }

    const out=await wb.outputAsync(); const blob=new Blob([out],{type:'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet'});
    const a=document.createElement('a'); a.href=URL.createObjectURL(blob); a.download=safeFilename(buildFilename()); a.click(); setTimeout(()=>URL.revokeObjectURL(a.href),1500);
    setInfo(`Скачано. Записано позиций: ${written}`);
  }catch(e){ setInfo(e.message,true); }
};

/* ============ Редактор памяти ============ */
const mapBody=document.getElementById('mapBody');
function renderMapEditor(){
  const mem=loadMemory(); mapBody.innerHTML='';
  for(const [k,v] of Object.entries(mem.map)){
    let shownText=v;
    if(!v.startsWith('#ROW:')){ for(const c of catalog){ if(c.norm===v){ shownText=c.text; break; } } }
    const tr=document.createElement('tr');
    tr.innerHTML=`<td contenteditable="true" class="key">${k}</td>
                  <td contenteditable="true" class="val">${shownText}</td>
                  <td><button class="btn" style="padding:6px 10px">✕</button></td>`;
    const del=tr.querySelector('button');
    del.onclick=()=>{ const mem=loadMemory(); delete mem.map[k]; saveMemory(mem); renderMapEditor(); };
    tr.querySelector('.key').onblur=()=>{ const newK=norm(tr.querySelector('.key').textContent||''); const mem=loadMemory(); const cur=mem.map[k]; delete mem.map[k]; if(newK) mem.map[newK]=cur; saveMemory(mem); renderMapEditor(); };
    tr.querySelector('.val').onblur=()=>{ const newVal=norm(tr.querySelector('.val').textContent||''); const mem=loadMemory(); mem.map[k]=newVal; saveMemory(mem); renderMapEditor(); };
    mapBody.appendChild(tr);
  }
}
document.getElementById('exportMap').onclick=()=>{
  const mem=loadMemory(); const blob=new Blob([JSON.stringify(mem,null,2)],{type:'application/json'});
  const a=document.createElement('a'); a.href=URL.createObjectURL(blob); a.download='ewl_mapping_text.json'; a.click(); setTimeout(()=>URL.revokeObjectURL(a.href),1200);
};
document.getElementById('importMap').onclick=()=>document.getElementById('importMapFile').click();
document.getElementById('importMapFile').onchange=async(e)=>{
  const f=e.target.files[0]; if(!f) return;
  try{ const txt=await f.text(); const data=JSON.parse(txt); if(!data.map) throw new Error('Нет поля map');
    localStorage.setItem(LS_KEY, JSON.stringify({version:2,map:data.map})); renderMapEditor(); setInfo('Импортировано');
  }catch{ setInfo('Ошибка импорта JSON',true); }
};
document.getElementById('clearMap').onclick=async()=>{ if(confirm('Очистить память соответствий?')){ localStorage.removeItem(LS_KEY); renderMapEditor(); } };
document.getElementById('clearOrder').onclick = () => {
  document.getElementById('order').value = '';
};
</script>

  </div>

  <!-- KPI embedded as iframe to avoid ID/script conflicts -->
  <div id="kpiSection" style="display:none">
    <iframe id="kpiFrame" srcdoc="&lt;!DOCTYPE html&gt;
&lt;!-- saved from url=(0070)file:///C:/Users/imfideo/Downloads/kpi_builder_target_final%20(1).html --&gt;
&lt;html lang=&quot;ru&quot;&gt;&lt;head&gt;&lt;style&gt;html,body{margin:0;padding:0;background:radial-gradient(1200px 420px at 50% 0%, rgba(255,226,163,.06), transparent 62%),radial-gradient(900px 360px at 80% 10%, rgba(255,214,138,.04), transparent 60%),radial-gradient(900px 520px at 20% 0%, rgba(120,170,255,.04), transparent 60%),linear-gradient(180deg,#01020a 0%,#020412 40%,#03061a 100%) !important;color:#eaf2ff;}body{min-height:100vh;}.container,.card,.panel,.box,.content{background:rgba(15,23,42,.82)!important;border:1px solid rgba(148,163,184,.22)!important;border-radius:18px!important;color:#eaf2ff!important;box-shadow:0 22px 60px rgba(0,0,0,.55)!important;}input,textarea,select{background:rgba(7,11,20,.78)!important;color:#eaf2ff!important;border:1px solid rgba(148,163,184,.22)!important;}
/* Hide scrollbars inside KPI iframe */
html, body { margin:0; height:100%; }
* { scrollbar-width: none; }
*::-webkit-scrollbar { width: 0 !important; height: 0 !important; }

&lt;/style&gt;&lt;meta http-equiv=&quot;Content-Type&quot; content=&quot;text/html; charset=UTF-8&quot;&gt;
  
  &lt;meta name=&quot;viewport&quot; content=&quot;width=device-width, initial-scale=1&quot;&gt;
  &lt;title&gt;KPI — Потери и избыток&lt;/title&gt;
  &lt;script src=&quot;https://cdn.jsdelivr.net/npm/xlsx/dist/xlsx.full.min.js&quot;&gt;&lt;/script&gt;&lt;script&gt;window.addEventListener(&quot;load&quot;,function(){if(!window.XLSX){alert(&quot;Не удалось загрузить библиотеку XLSX (cdn.jsdelivr). Проверьте подключение или CSP.&quot;);}});&lt;/script&gt;
  &lt;style&gt;
    :root { color-scheme: dark; }
    body { font-family: Inter, system-ui, -apple-system, Segoe UI, Roboto, Arial, &quot;Noto Sans&quot;, &quot;Helvetica Neue&quot;, sans-serif; background:#0b1020; color:#eaf0ff; margin:0; padding:24px; }
    .wrap { max-width: 920px; margin: 0 auto; }
    .card { background:#121a34; border:1px solid rgba(122,162,255,.25); border-radius:14px; padding:18px; }
    h1 { margin:0 0 8px; }
    .row { display:flex; gap:12px; flex-wrap:wrap; align-items:center; }
    input[type=file] { display:block; margin: 8px 0; }
    .btn { background:#1b2750; color:white; border:none; border-radius:10px; padding:10px 14px; cursor:pointer; font-weight:600; }
    .btn:hover { background:#2a3a70; }
    .muted { color:#9fb2ff; font-size:14px; }
    table { border-collapse: collapse; width:100%; margin-top:12px; }
    th,td { border-bottom:1px solid #7aa2ff55; padding:8px; font-size:14px; text-align:left; }
    #status { margin-top:8px; min-height:20px; }
  &lt;/style&gt;
&lt;/head&gt;
&lt;body&gt;
  &lt;div class=&quot;wrap&quot;&gt;
    &lt;div class=&quot;card&quot;&gt;
      &lt;h1&gt;KPI — Потери и избыток&lt;/h1&gt;
      &lt;p class=&quot;muted&quot;&gt;&lt;/p&gt;
      &lt;input type=&quot;file&quot; id=&quot;file&quot; multiple=&quot;&quot; accept=&quot;.xlsx&quot;&gt;
      &lt;div class=&quot;row&quot;&gt;
        &lt;button id=&quot;preview&quot; type=&quot;button&quot; class=&quot;btn&quot;&gt;Предпросмотр&lt;/button&gt;
        &lt;button id=&quot;process&quot; type=&quot;button&quot; class=&quot;btn&quot;&gt;Скачать KPI.xlsx&lt;/button&gt;
      &lt;/div&gt;
      &lt;div id=&quot;count&quot; class=&quot;muted&quot;&gt;&lt;/div&gt;
      &lt;div id=&quot;status&quot; class=&quot;muted&quot;&gt;Выберите несколько файлов и нажмите кнопку.&lt;/div&gt;
      &lt;div id=&quot;previewBox&quot;&gt;&lt;/div&gt;
    &lt;/div&gt;
  &lt;/div&gt;

  &lt;script&gt;
  (function(){
    &quot;use strict&quot;;
    const METRIC_MAP = new Map([
      [&#x27;Итого потери&#x27;, &#x27;Потери, руб.&#x27;],
      [&#x27;Неучтённые потери&#x27;, &#x27;Неучтенные потери, руб.&#x27;],
      [&#x27;Списания&#x27;, &#x27;Списания, руб.&#x27;],
      [&#x27;Итого избыток&#x27;, &#x27;Избыток, руб.&#x27;],
    ]);

    let picked = [];
    const fileInput = document.getElementById(&#x27;file&#x27;);
    const previewBtn = document.getElementById(&#x27;preview&#x27;);
    const processBtn = document.getElementById(&#x27;process&#x27;);
    const previewBox = document.getElementById(&#x27;previewBox&#x27;);
    const countEl = document.getElementById(&#x27;count&#x27;);
    const statusEl = document.getElementById(&#x27;status&#x27;);

    function log(msg){ if(statusEl) statusEl.textContent = msg; console.log(&#x27;[KPI]&#x27;, msg); }
    function setPicked(files){
      picked = Array.from(files || []);
      countEl.textContent = picked.length ? `Выбрано файлов: ${picked.length}` : &#x27;&#x27;;
    }
    fileInput.addEventListener(&#x27;change&#x27;, (e)=&gt; setPicked(e.target.files));

    function readFileArrayBuffer(file){
      return new Promise((resolve, reject)=&gt;{
        const r = new FileReader();
        r.onload = ()=&gt; resolve(r.result);
        r.onerror = ()=&gt; reject(r.error || new Error(&#x27;read failed&#x27;));
        r.readAsArrayBuffer(file);
      });
    }

    function to2(v){
      if (v === &#x27;&#x27; || v === null || v === undefined) return &#x27;&#x27;;
      const num = parseFloat(String(v).toString().replace(&#x27;,&#x27;, &#x27;.&#x27;));
      if (isNaN(num)) return v;
      return num.toFixed(2).replace(&#x27;.&#x27;, &#x27;,&#x27;);
    }

    function extractBlock(wb){
      const sh = wb.Sheets[wb.SheetNames[0]];
      const aoa = XLSX.utils.sheet_to_json(sh, { header: 1, defval: &#x27;&#x27; });
      let pizzeria = &#x27;&#x27;;
      const out = [];

      for (let i=0; i&lt;aoa.length; i++){
        const row = aoa[i];
        const a = row[0];
        const b = row[1];
        const c = row[2];
        if (a === &#x27;Пиццерия&#x27;){ pizzeria = String(b || &#x27;&#x27;).trim(); }
        if (METRIC_MAP.has(a)){
          const label = METRIC_MAP.get(a);
          out.push([label, to2(b)]);
        }
      }
      if (!out.length &amp;&amp; pizzeria){
        // ничего не нашли — вернем пустой блок, чтобы было видно пиццерию
        return [[&#x27;Пиццерия&#x27;, pizzeria, &#x27;&#x27;]];
      }
      // Соберем окончательный блок: шапка пиццерии + строки
      const final = [[&#x27;Пиццерия&#x27;, pizzeria]];
      for (const r of out) final.push(r);
      // убран разделитель
      return final;
    }

    async function collectAll(){
      const all = [];
      for (const f of picked){
        const ab = await readFileArrayBuffer(f);
        const wb = XLSX.read(ab, { type:&#x27;array&#x27; });
        all.push(...extractBlock(wb));
      }
      return all;
    }

    function renderPreview(rows){
      if (!rows.length){ previewBox.innerHTML = &#x27;&lt;p class=&quot;muted&quot;&gt;Нет данных.&lt;/p&gt;&#x27;; return; }
      let html = &#x27;&lt;table&gt;&lt;tr&gt;&lt;th&gt;Показатель&lt;/th&gt;&lt;th&gt;Сумма&lt;/th&gt;&lt;/tr&gt;&#x27;;
      for (const r of rows){ html += &#x27;&lt;tr&gt;&#x27; + r.map(v=&gt;`&lt;td&gt;${v??&#x27;&#x27;}&lt;/td&gt;`).join(&#x27;&#x27;) + &#x27;&lt;/tr&gt;&#x27;; }
      html += &#x27;&lt;/table&gt;&#x27;;
      previewBox.innerHTML = html;
    }

    previewBtn.addEventListener(&#x27;click&#x27;, async (ev)=&gt;{
      ev.preventDefault();
      log(&#x27;Нажат Предпросмотр&#x27;);
      try {
        const rows = await collectAll();
        renderPreview(rows.slice(0, 120));
        log(&#x27;Предпросмотр готов&#x27;);
      } catch (e){ console.error(e); log(&#x27;Ошибка предпросмотра: &#x27;+e.message); alert(&#x27;Ошибка предпросмотра: &#x27;+e.message); }
    });

    processBtn.addEventListener(&#x27;click&#x27;, async (ev)=&gt;{
      ev.preventDefault();
      log(&#x27;Нажато Скачать&#x27;);
      try {
        const rows = await collectAll();
        const wb = XLSX.utils.book_new();
        const ws = XLSX.utils.aoa_to_sheet(rows);
        XLSX.utils.book_append_sheet(wb, ws, &#x27;Sheet&#x27;);
        XLSX.writeFile(wb, &#x27;KPI.xlsx&#x27;);
        log(&#x27;Файл сохранён&#x27;);
      } catch (e){ console.error(e); log(&#x27;Ошибка сохранения: &#x27;+e.message); alert(&#x27;Ошибка сохранения: &#x27;+e.message); }
    });

    log(&#x27;Готово. Выберите файлы и нажмите кнопку.&#x27;);
  })();
  &lt;/script&gt;


&lt;/body&gt;&lt;/html&gt;" style="width:100%;height:100%;border:0;overflow:hidden;"></iframe>
  </div>

  <!-- CALC embedded as iframe -->
  <script>
  // Tabs: EWL ↔ KPI (calc removed)
  (function(){
    const tabE = document.getElementById('tabEWL');
    const tabK = document.getElementById('tabKPI');
    const secE = document.getElementById('ewlSection');
    const secK = document.getElementById('kpiSection');

    function safeHide(el){ if(el) el.style.display='none'; }
    function safeShow(el){ if(el) el.style.display='block'; }
    function setActive(btn, on){ if(!btn) return; btn.classList.toggle('active', !!on); }

    function activate(which){
      safeHide(secE); safeHide(secK);
      setActive(tabE,false); setActive(tabK,false);

      if(which==='kpi'){
        safeShow(secK); setActive(tabK,true);
      } else {
        safeShow(secE); setActive(tabE,true);
      }
    }

    if(tabE){ tabE.addEventListener('click', (e)=>{ e.preventDefault(); activate('ewl'); }); }
    if(tabK){ tabK.addEventListener('click', (e)=>{ e.preventDefault(); activate('kpi'); }); }

    // Default
    activate('ewl');

    // KPI iframe autosize (only if present)
    const frame = document.getElementById('kpiFrame');
    if(frame){
      const resize = () => {
        try{
          const doc = frame.contentDocument || frame.contentWindow?.document;
          if(!doc || !doc.body) return;
          const h = Math.max(doc.body.scrollHeight, doc.documentElement?.scrollHeight || 0);
          if(h) frame.style.height = (h + 24) + 'px';
        }catch(_){}
      };
      frame.addEventListener('load', resize);
      setTimeout(resize, 400);
      setTimeout(resize, 1200);
      setTimeout(resize, 2500);
    }
  })();
</script>

  <!-- Инициализация flatpickr после того, как DOM уже отрисован -->
  <script>
    document.addEventListener('DOMContentLoaded', () => {
      if (window.flatpickr) {
        flatpickr("#date", {
          dateFormat: "d.m.Y",
          allowInput: true,
          locale: flatpickr.l10ns.ru
        });
      }
    });
  </script>

<script>
/* ===================== New Year Garland init ===================== */
(() => {
  const bulbsEl = document.getElementById('ny-bulbs');
  const snowEl  = document.getElementById('ny-snow');

  const wireGlow = document.getElementById('ny-wireGlow');
  const wireBase = document.getElementById('ny-wireBase');
  const wireHighlight = document.getElementById('ny-wireHighlight');

  const params = [{"amp": 1.2071415981588367, "dur": 7.239089544321984, "delay": -0.4547364958576239, "scale": 1.0038170126179593, "warm": 0.01586254003684983, "bright": 0.9609723589239753}, {"amp": 0.966194309469389, "dur": 7.047634556167222, "delay": -2.2207036786991887, "scale": 1.0627358370535915, "warm": -0.029646419814785968, "bright": 0.8928163030298861}, {"amp": 0.8816034837426555, "dur": 8.23857813746871, "delay": -1.8393691047525653, "scale": 0.9275384605465723, "warm": 0.06804127628786563, "bright": 1.051541867470136}, {"amp": 1.3885302801804564, "dur": 7.462250818314283, "delay": -5.055035429159025, "scale": 0.9227001326509289, "warm": 0.01812193927875267, "bright": 0.8342922652405251}, {"amp": 0.9711874365181362, "dur": 5.967772054660859, "delay": -5.819504464651269, "scale": 1.0035082030201914, "warm": 0.008458422832232249, "bright": 1.0221825108444478}, {"amp": 1.267211703287669, "dur": 7.561166831676708, "delay": -3.00136108675925, "scale": 1.0392409157402662, "warm": 0.010306286975951352, "bright": 0.8867590959193326}, {"amp": 1.6978905804167759, "dur": 8.982766566624797, "delay": -0.9587067030428287, "scale": 1.047405731869631, "warm": -0.005319506128289506, "bright": 0.8751198163858973}, {"amp": 1.0601359525827818, "dur": 5.280893998239703, "delay": -1.402272681537558, "scale": 0.9920719648853285, "warm": 0.05312419840692966, "bright": 0.9127632476094243}, {"amp": 1.662238144987832, "dur": 8.389239093211218, "delay": -5.9967303776665775, "scale": 0.95774913465133, "warm": 0.060129912091459965, "bright": 0.9327969462432799}, {"amp": 1.6823230470568629, "dur": 6.589697552317125, "delay": -5.561769936997813, "scale": 1.0333018842021244, "warm": 0.0456361944544316, "bright": 0.8847461408440342}, {"amp": 0.8784297785169531, "dur": 6.330342501853392, "delay": -0.21554270043741575, "scale": 1.0564472930588766, "warm": -0.02702091526384941, "bright": 0.8791331077343512}, {"amp": 0.8909416780610346, "dur": 5.239573611764307, "delay": -1.217870928936156, "scale": 0.951982063075706, "warm": 0.02152246557714344, "bright": 0.9273819706002452}, {"amp": 0.9716159737613295, "dur": 7.927576862857402, "delay": -5.214197497700281, "scale": 1.03586872226801, "warm": -0.027184121359632385, "bright": 0.920981348139141}, {"amp": 0.9915791057081805, "dur": 6.079179908762393, "delay": -0.17442566268785065, "scale": 1.0646140705547729, "warm": -0.006544033514191153, "bright": 1.032367627059753}, {"amp": 0.9896391992909955, "dur": 6.577098548288218, "delay": -0.8737385897926169, "scale": 1.035530418186283, "warm": -0.02896339725977288, "bright": 1.0574324074024415}, {"amp": 0.9919190317197704, "dur": 6.033110231446482, "delay": -1.3638618613630609, "scale": 0.9792119765985915, "warm": -0.007404276114115899, "bright": 0.8376156528132217}, {"amp": 0.8811054556657373, "dur": 7.330939192670208, "delay": -4.541922479174626, "scale": 1.028231091844749, "warm": 0.0008874451252551055, "bright": 0.9287699451337238}, {"amp": 1.6632212052385817, "dur": 6.93489813305018, "delay": -2.552572527420315, "scale": 1.0759746202044, "warm": -0.019888951264344628, "bright": 0.8569924765422545}, {"amp": 1.6175813578482345, "dur": 8.271207797838592, "delay": -4.5030086014245025, "scale": 0.9541641198733869, "warm": 0.041336682879831645, "bright": 1.045697175062772}, {"amp": 0.9769308158626899, "dur": 8.800543409234582, "delay": -0.7068614744015242, "scale": 1.02863615866102, "warm": 0.006360294634209368, "bright": 0.8449215235275875}, {"amp": 0.8348268245244044, "dur": 8.85072604582246, "delay": -4.569556843944103, "scale": 1.046824302900508, "warm": -0.011732046184765681, "bright": 1.0176922832217647}, {"amp": 1.336819675876942, "dur": 6.173741385938948, "delay": -4.947399619404845, "scale": 1.0496635989538736, "warm": -0.0324346263415812, "bright": 0.87481512095803}, {"amp": 1.303429708541608, "dur": 8.409599501367525, "delay": -2.3141819056507913, "scale": 0.9704394906627539, "warm": 0.06090961963418328, "bright": 0.8689549310487242}, {"amp": 0.8149173137712397, "dur": 6.076775712115364, "delay": -3.325766880107044, "scale": 0.9308820036678588, "warm": -0.02061208470899011, "bright": 0.908508488889343}, {"amp": 1.3149524806123867, "dur": 5.526314082509044, "delay": -3.8271290598031147, "scale": 1.0803692413945662, "warm": 0.06785427634720612, "bright": 0.9776636911622973}, {"amp": 1.422099432123788, "dur": 7.337761072720715, "delay": -5.1579168771262935, "scale": 0.926314496593518, "warm": -0.03803163832256781, "bright": 1.038450988574276}, {"amp": 1.4308730168687123, "dur": 8.851084054516013, "delay": -5.872444930745392, "scale": 1.0345132138838624, "warm": 0.013045929501948973, "bright": 0.9953195154268677}, {"amp": 1.0870140412669274, "dur": 8.99743050552702, "delay": -5.548422599445697, "scale": 1.0182971646353578, "warm": 0.04107060443528849, "bright": 1.036047011499851}, {"amp": 1.463379320974904, "dur": 7.814762476967109, "delay": -1.2403999434390958, "scale": 1.0847004643193672, "warm": -0.0012982493688020874, "bright": 0.9844350292800875}, {"amp": 1.610752345397341, "dur": 8.484405036488043, "delay": -3.4970811481368838, "scale": 1.062295760105912, "warm": 0.0549819941445576, "bright": 0.9574737996122823}, {"amp": 1.3624644919934772, "dur": 6.529334109401, "delay": -2.503926649133243, "scale": 1.0295960421339039, "warm": -0.03117777682862187, "bright": 0.9734570350329524}, {"amp": 1.69398996927949, "dur": 8.519167316444108, "delay": -1.6307575406067132, "scale": 0.989918539733926, "warm": 0.04085419667033265, "bright": 0.9594286908944054}, {"amp": 1.1964702458408474, "dur": 8.353480116762276, "delay": -5.49730666643245, "scale": 1.0550378319070908, "warm": -0.03672311869169885, "bright": 0.9643084634919147}, {"amp": 1.232861133814317, "dur": 5.9208865749059845, "delay": -1.8099919209084696, "scale": 1.0095051039784424, "warm": 0.027595358808446484, "bright": 1.0409114256256176}, {"amp": 1.0302471980957435, "dur": 5.045228820084075, "delay": -4.193804153358026, "scale": 1.042064656243596, "warm": -0.017716814525251028, "bright": 0.86070571676571}, {"amp": 1.6151494399329411, "dur": 7.639960018703384, "delay": -3.3484051153818806, "scale": 1.0805108456571928, "warm": -0.0040343319287651225, "bright": 0.9798157750080811}, {"amp": 0.9786552009787843, "dur": 6.723581129423193, "delay": -1.1640696039216358, "scale": 1.084559815794621, "warm": 0.05682958098918812, "bright": 0.9122604838959767}, {"amp": 1.324796468978547, "dur": 6.265947377976553, "delay": -5.182942041700211, "scale": 1.0093640674884181, "warm": 0.05208051792175935, "bright": 1.0236928731928572}, {"amp": 1.4400959853658462, "dur": 8.80000060738206, "delay": -4.339224018669533, "scale": 0.9504432038985885, "warm": 0.009571439637606483, "bright": 0.886039077506778}, {"amp": 0.9926723394379506, "dur": 6.65593920298064, "delay": -2.245598650575788, "scale": 1.0088975660576411, "warm": -0.0053091190100429675, "bright": 1.0213884189878142}, {"amp": 1.6838328552417359, "dur": 6.809909353266543, "delay": -5.551924698260694, "scale": 0.9256674396251311, "warm": 0.05601119597875328, "bright": 0.8299572158067012}, {"amp": 1.4377678361010797, "dur": 7.282327841347895, "delay": -4.1458178915402435, "scale": 1.06247243390625, "warm": -0.03789745837071234, "bright": 0.852611478099565}, {"amp": 1.2093491723457475, "dur": 5.098906033313666, "delay": -1.0219893932456152, "scale": 0.9627336215992702, "warm": -0.024503802153071727, "bright": 0.8312662166071163}, {"amp": 1.366262275008666, "dur": 6.78592306700409, "delay": -2.2202145813975527, "scale": 1.0379077472924059, "warm": 0.048812340204083475, "bright": 1.0500305564605625}];
  const N = params.length;

  function yAt(t){
    // natural sag with slight irregularity
    return 46 + 13*Math.sin(t*Math.PI*2) + 8*Math.sin(t*Math.PI*4 + 0.9);
  }
  function yWire(t){ return yAt(t); }

  // draw wire path in stage coordinate system (1500x150)
  const W = 1500;
  const steps = 90;
  let d = "";
  for (let s=0; s<=steps; s++) {
    const tt = s/steps;
    const x = tt*W;
    const y = yWire(tt);
    d += (s===0 ? `M ${x.toFixed(2)} ${y.toFixed(2)}` : ` L ${x.toFixed(2)} ${y.toFixed(2)}`);
  }
  wireGlow.setAttribute("d", d);
  wireBase.setAttribute("d", d);
  wireHighlight.setAttribute("d", d);

  // build bulbs
  for (let i=0; i<N; i++) {
    const t = (i+0.5)/N;
    const x = t*100;        // %
    const y = yWire(t);     // px

    const p = params[i];

    const wrap = document.createElement('div');
    wrap.className = 'ny-bulbWrap';
    wrap.style.left = x + '%';
    wrap.style.top  = y + 'px';

    // subtle placement variance (real-life irregularity)
    wrap.style.marginTop = ((Math.random()*3.6)-1.8).toFixed(2) + 'px';

    const sway = (0.9 + 0.7*Math.random()) * p.amp; // deg
    wrap.style.setProperty('--ny-sway', sway.toFixed(2) + 'deg');
    wrap.style.animation = `ny-sway ${p.dur.toFixed(2)}s ease-in-out ${p.delay.toFixed(2)}s infinite`;

    const drop = document.createElement('div');
    drop.className = 'ny-drop';

    const cap = document.createElement('div');
    cap.className = 'ny-cap';

    const bulb = document.createElement('div');
    bulb.className = 'ny-bulb';

    const s = (p.scale * (0.94 + Math.random()*0.16));
    bulb.style.transform = `translateX(-50%) scale(${s.toFixed(2)})`;

    const flickDur = (2.6 + Math.random()*1.6);
    const flickDel = (-Math.random()*3.2);
    bulb.style.animation = `ny-flicker ${flickDur.toFixed(2)}s ease-in-out ${flickDel.toFixed(2)}s infinite`;

    const hue = (p.warm*18);
    bulb.style.filter = `brightness(${p.bright.toFixed(2)}) saturate(${(1.05+Math.random()*0.18).toFixed(2)}) hue-rotate(${hue.toFixed(2)}deg)`;

    wrap.appendChild(drop);
    wrap.appendChild(cap);
    wrap.appendChild(bulb);
    bulbsEl.appendChild(wrap);
  }

  // snow (subtle)
  for (let i=0;i<54;i++) {
    const s = document.createElement('i');
    s.style.left = (Math.random()*100).toFixed(2) + '%';
    s.style.animationDuration = (14 + Math.random()*16).toFixed(2) + 's';
    s.style.opacity = (0.28 + Math.random()*0.50).toFixed(2);
    s.style.transform = `translateY(${(-10 - Math.random()*80).toFixed(1)}vh)`;
    snowEl.appendChild(s);
  }
})();
</script>


<script>
(function(){
  function addSnowcap(){
    const targets = new Set([
      "EWL Order","KPI","Предпросмотр","Скачать Excel","Запомнить шаблон","Забыть"     ]);
    document.querySelectorAll("button, .btn, .nav-btn").forEach(b=>{
      const t = (b.textContent||"").trim();
      if(targets.has(t)) b.classList.add("");
    });
  }
  if(document.readyState === "loading") document.addEventListener("DOMContentLoaded", addSnowcap);
  else addSnowcap();
})();
</script>


<script>
(function(){
  const snow = document.getElementById('snow');
  if(!snow) return;
  snow.innerHTML = '';
  const COUNT = 70;
  for(let i=0;i<COUNT;i++){
    const s = document.createElement('i');
    s.style.left = (Math.random()*100).toFixed(2) + '%';
    s.style.opacity = (0.25 + Math.random()*0.55).toFixed(2);
    s.style.animationDuration = (14 + Math.random()*18).toFixed(2) + 's';
    s.style.animationDelay = (-Math.random()*18).toFixed(2) + 's';
    const size = (1.4 + Math.random()*2.6);
    s.style.width = s.style.height = size.toFixed(2) + 'px';
    snow.appendChild(s);
  }
})();
</script>

</body>
</html>

