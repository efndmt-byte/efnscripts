<!doctype html>
<html lang="ru">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>EWL Order — текстовая память соответствий</title>
<script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/xlsx-populate/browser/xlsx-populate.min.js"></script>
<style>
  :root{--bg:#0b1020;--fg:#eaf0ff;--mut:#9fb2ff;--panel:#121a34;--border:#7aa2ff40;--accent:#1b2750}
  *{box-sizing:border-box}
  body{font-family:system-ui,Segoe UI,Roboto,Arial,sans-serif;background:var(--bg);color:var(--fg);margin:0;padding:24px}
  .card{background:var(--panel);border:1px solid var(--border);border-radius:16px;max-width:1360px;margin:0 auto;padding:18px}
  h1{margin:0 0 10px}
  label{display:block;margin-top:10px;color:var(--mut);font-weight:600}
  input,select,textarea,button{width:100%;border-radius:12px;border:1px solid #7aa2ff55;background:#0f1530;color:var(--fg);padding:10px;margin-top:6px}
  textarea{min-height:220px;white-space:pre;font-family:ui-monospace,Consolas,Menlo,monospace}
  .row{display:grid;grid-template-columns:1.2fr 0.8fr;gap:40px;align-items:start}
  .btn{cursor:pointer;font-weight:700;background:var(--accent);width:auto;display:inline-block;margin-right:8px}
  table{border-collapse:collapse;width:100%;margin-top:12px}
  th,td{border-bottom:1px solid #7aa2ff55;padding:8px;vertical-align:top} th{color:var(--mut)}
  tr.unmatched td{background:#51202a} tr.duplicate td{background:#58461c} tr.unmatched.duplicate td{background:#60313a}
  .legend{display:flex;gap:10px;align-items:center;margin-top:6px;flex-wrap:wrap}
  .chip{display:inline-block;padding:4px 8px;border-radius:999px;border:1px solid #7aa2ff55}
  .chip.unm{background:#51202a} .chip.dupl{background:#58461c}
  .toolbar{display:flex;gap:10px;align-items:center;flex-wrap:wrap;margin:8px 0}

  input[type="checkbox"] {
  width: 14px;
  height: 14px;
  border-radius: 4px; /* лёгкое скругление */
  accent-color: #7aa2ff; /* цвет галочки и фона чекбокса */
}

  label {
  display: inline-flex;
  align-items: center;
  gap: 4px; /* расстояние между квадратиком и текстом */
}
  
  #info{min-height:20px} .error{color:#ffa2a2} .ok{color:#b5ffbf}
  .modal{position:fixed;inset:0;background:#0008;display:none;align-items:center;justify-content:center;z-index:50}
  .modal>.box{background:#0f1530;border:1px solid #7aa2ff55;border-radius:14px;max-width:900px;width:90%;padding:12px}
  .modal input{width:100%}
  .results{max-height:420px;overflow:auto;margin-top:8px;border:1px solid #7aa2ff33;border-radius:10px}
  .resitem{padding:8px 10px;border-bottom:1px solid #7aa2ff22;cursor:pointer}
  .resitem:hover{background:#15204a}
  .selectWrap{position:relative}
  .selectWrap select{pointer-events:none}
  .selectCover{position:absolute;inset:0;background:transparent;border-radius:12px;border:none;cursor:pointer}
</style>
</head>
<body>
<div class="card">
  <h1>EWL Order</h1>

  <label>Шаблон Excel (.xlsx)</label>
  <input type="file" id="tmpl" accept=".xlsx">
  <div class="toolbar" style="margin-top:6px">
    <button class="btn" id="remember">Запомнить шаблон</button>
    <button class="btn" id="clearStored">Забыть шаблон</button>
    <span id="storedInfo" style="color:#9fb2ff"></span>
  </div>

  <div class="row" style="margin-top:10px">
    <div>
      <label>Текст заказа</label>
      <textarea id="order" placeholder="После «Наименование» — по строке на позицию, число в конце — количество."></textarea>
      <div class="toolbar">
        <button class="btn" id="clearOrder">Очистить текст</button>
      </div>
    </div>
    <div>
      <label>Ресторан</label>
      <input id="citySearch" type="text" placeholder="Поиск пиццерии...">
      <select id="city" size="8" style="height:220px"></select>
      <label>Дата</label>
      <input type="date" id="date">
      <div class="toolbar">
        <button class="btn" id="preview">Предпросмотр</button>
        <button class="btn" id="download">Скачать Excel</button>
      </div>
      <div style="margin-top:8px;color:#cde3ff">
        <div id="statMatched">Совпадений: 0 / 0</div>
        <div id="statTotal">Итого заказано единиц: 0</div>
        <div id="info"></div>
        <div class="legend"><span class="chip unm">нет совпадения</span><span class="chip dupl">дубликат</span></div>
      </div>
    </div>
  </div>

  <div class="toolbar">
    <label style="display:flex;gap:8px"><input type="checkbox" id="hideMatched">Скрывать совпавшие</label>
    <label style="display:flex;gap:8px"><input type="checkbox" id="onlyProblems">Только проблемные</label>
    <input type="text" id="optionFilter" placeholder="Фильтр по Order!D (подстрока)">
  </div>

  <label>Соответствия (память по тексту)</label>
  <table>
    <thead><tr><th>Из заказа</th><th>Order!D (текст)</th><th>Qty</th></tr></thead>
    <tbody id="tbMap"></tbody>
  </table>

  <details style="margin-top:16px">
    <summary>Редактор соответствий (память)</summary>
    <div class="toolbar">
      <button class="btn" id="exportMap" style="padding:6px 10px">Экспорт JSON</button>
      <input type="file" id="importMapFile" accept=".json" style="display:none">
      <button class="btn" id="importMap" style="padding:6px 10px">Импорт JSON</button>
      <button class="btn" id="clearMap" style="padding:6px 10px">Очистить память соответствий</button>
    </div>
    <table id="mapTable">
      <thead><tr><th>Ключ (normalize из заказа)</th><th>Шаблонный текст (normalize из Order!D)</th><th></th></tr></thead>
      <tbody id="mapBody"></tbody>
    </table>
  </details>
</div>

<!-- Оверлей-поиск -->
<div class="modal" id="picker">
  <div class="box">
    <input type="text" id="pickerQuery" placeholder="Ищите по подстроке, можно несколько слов через пробел">
    <div class="results" id="pickerResults"></div>
    <div style="display:flex;justify-content:flex-end;margin-top:8px">
      <button class="btn" id="pickerClose" style="padding:6px 10px">Закрыть (Esc)</button>
    </div>
  </div>
</div>

<script>
// ------------------- утилиты -------------------
const infoEl = document.getElementById('info');
function setInfo(msg,isErr=false){ infoEl.textContent = msg||''; infoEl.classList.toggle('error', !!isErr); infoEl.classList.toggle('ok', !!(!isErr && msg)); }
window.addEventListener('error', e=>setInfo(e.message,true));
window.addEventListener('unhandledrejection', e=>setInfo(String(e.reason?.message||e.reason),true));

function norm(s) {
  return String(s ?? "")
    .toLowerCase()
    .replace(/[ё]/g,'е')
    .replace(/[“”«»„‟"']/g,'')
    .replace(/[–—―−‐-]/g,'-')
    .replace(/[_/\\]/g,' ')
    .replace(/\s*\([^)]*\)\s*/g,' ')
    .replace(/\s*\[[^\]]*\]\s*/g,' ')
    .replace(/[.,;:!?\-()]/g,' ')
    .replace(/\s{2,}/g,' ')
    .trim();
}
function normalizeLines(t){ return t.replace(/\u00A0/g,' ').replace(/\r\n|\n|\r/g,'\n'); }
function findStartIndex(lines){ for(let i=0;i<lines.length;i++){ const s=lines[i].toLowerCase().replace(/[^\p{L}]+/gu,'').trim(); if(s.startsWith('наименование')) return i+1; } return -1; }
function lastNumberLax(str){ const m=str.match(/(\d+(?:[.,]\d+)?)(?:\D*)$/u); if(!m) return null; const v=parseFloat(m[1].replace(',','.')); return Number.isFinite(v)?v:null; }
function parseOrder(text){ const lines=normalizeLines(text).split('\n'); const start=findStartIndex(lines); const rows=[]; if(start<0) return rows; for(let i=start;i<lines.length;i++){ let line=lines[i].trim(); if(!line) continue; const qty=lastNumberLax(line); if(qty==null) continue; line=line.replace(/(\d+(?:[.,]\d+)?)(?:\D*)$/u,'').trim(); if(!line) continue; rows.push([line,qty]); } return rows; }

// ------------------- память v2 (localStorage) -------------------
const LS_KEY='ewl_mapper_v2'; // { version:2, map: { userNorm: templateNorm } }

function loadMemory(){
  try{
    const raw=localStorage.getItem(LS_KEY);
    if(!raw) return {version:2,map:{}};
    const data=JSON.parse(raw);
    if(data.version===2 && data.map) return data;

    // попытка миграции из старых форматов
    const migrated={version:2,map:{}};
    const old = data.map || data || {};
    for(const [userNorm,val] of Object.entries(old)){
      if(val && typeof val==='object'){
        if(val.templateText){ migrated.map[userNorm]=norm(val.templateText); }
        else if(typeof val.destR==='number'){ migrated.map[userNorm]=`#ROW:${val.destR}`; }
      }
    }
    localStorage.setItem(LS_KEY, JSON.stringify(migrated));
    return migrated;
  }catch(e){ return {version:2,map:{}}; }
}
function saveMemory(mem){ localStorage.setItem(LS_KEY, JSON.stringify(mem)); }
function rememberMatch(userText, templateText){
  const mem=loadMemory();
  mem.map[norm(userText)] = norm(templateText);
  saveMemory(mem);
}
function forgetMatch(userText){
  const mem=loadMemory();
  delete mem.map[norm(userText)];
  saveMemory(mem);
}

// ------------------- состояние страницы -------------------
const storedInfo = document.getElementById('storedInfo');
const citySel = document.getElementById('city');
const citySearch = document.getElementById('citySearch');
const dateInput = document.getElementById('date');
const tbMap = document.getElementById('tbMap');
const statMatched = document.getElementById('statMatched');
const statTotal = document.getElementById('statTotal');
const hideMatched = document.getElementById('hideMatched');
const onlyProblems = document.getElementById('onlyProblems');
const optionFilter = document.getElementById('optionFilter');

let templateBuf=null, templateName=null;
let catalog=[], assignments=[], lastRows=[], rowMetas=[]; // catalog: [{r,text,norm}]

dateInput.value=new Date().toISOString().slice(0,10);
document.getElementById('clearOrder').onclick=()=>{ document.getElementById('order').value=''; };

<!-- ================= IndexedDB и кэш ================= -->
<script>
// Имена ключей в IndexedDB
const DB = 'ewl_order_prod_db';
const STORE = 'kv';
const KEY_BUF = 'template_buf';
const KEY_NAME = 'template_name';
const KEY_CITIES = 'cities_cache_v1';

// Базовые функции IndexedDB
function idb(){
  return new Promise((res,rej)=>{
    const r = indexedDB.open(DB,1);
    r.onupgradeneeded = () => r.result.createObjectStore(STORE);
    r.onsuccess = () => res(r.result);
    r.onerror = () => rej(r.error);
  });
}
async function getKV(k){
  const d = await idb();
  return new Promise((res,rej)=>{
    const tx=d.transaction(STORE,'readonly');
    const st=tx.objectStore(STORE);
    const r=st.get(k);
    r.onsuccess=()=>res(r.result ?? null);
    r.onerror =()=>rej(r.error);
  });
}
async function setKV(k,v){
  const d = await idb();
  return new Promise((res,rej)=>{
    const tx=d.transaction(STORE,'readwrite');
    const st=tx.objectStore(STORE);
    const r=st.put(v,k);
    r.onsuccess=()=>res();
    r.onerror =()=>rej(r.error);
  });
}
async function delKV(k){
  const d = await idb();
  return new Promise((res,rej)=>{
    const tx=d.transaction(STORE,'readwrite');
    const st=tx.objectStore(STORE);
    const r=st.delete(k);
    r.onsuccess=()=>res();
    r.onerror =()=>rej(r.error);
  });
}

/* ---------- Список пиццерий (кэш + отрисовка + поиск) ---------- */

// Отрисовать options в <select id="city">
function populateCities(cities) {
  const sel = document.getElementById('city');
  if (!sel) return;
  sel.innerHTML = '';
  if (!Array.isArray(cities)) return;

  for (const { code, name } of cities) {
    if (!name) continue;
    const o = document.createElement('option');
    o.value = name;
    o.textContent = name;
    if (code != null) o.dataset.code = String(code);
    sel.appendChild(o);
  }
}

// Кэширование списка
async function getCachedCities(){ try { const v = await getKV(KEY_CITIES); return Array.isArray(v)?v:null; } catch { return null; } }
async function setCachedCities(cities){ try { await setKV(KEY_CITIES, cities); } catch {} }

// Поиск по полю #citySearch
function hookCitySearch() {
  const input = document.getElementById('citySearch');
  const sel   = document.getElementById('city');
  if (!input || !sel) return;

  input.addEventListener('input', () => {
    const q = (input.value || '').trim().toLowerCase();
    [...sel.options].forEach(opt => {
      const txt = (opt.textContent || '').toLowerCase();
      opt.hidden = q && !txt.includes(q);
    });
  });
}

/* ---------- Извлечение городов из workbook (лист L1 / похожие) ---------- */

function extractCitiesFromWorkbook(wb) {
  if (!wb) return [];

  // ищем L1 или похожие листы
  const candidates = ['L1','Л1','L_1','L-1'];
  let sh = null;
  for (const n of candidates) if (wb.Sheets[n]) { sh = wb.Sheets[n]; break; }
  if (!sh) {
    const guess = wb.SheetNames.find(n => /l1|список|города|пиццер/i.test(n)) || wb.SheetNames[0];
    sh = wb.Sheets[guess];
  }
  if (!sh) return [];

  // читаем как матрицу
  const rows = XLSX.utils.sheet_to_json(sh, { header: 1, blankrows: false, defval:'' });
  if (!rows.length) return [];

  // определяем колонки
  const hdr = rows[0].map(v => (v ?? '').toString().trim().toLowerCase());
  let codeCol = -1, nameCol = -1;
  hdr.forEach((h,i)=>{
    if (codeCol<0 && /код|code/i.test(h)) codeCol = i;
    if (nameCol<0 && /(назв|пиццер|город|name)/i.test(h)) nameCol = i;
  });
  if (nameCol < 0 && rows[0].length >= 3) { codeCol = 1; nameCol = 2; } // B=код, C=назв

  const out = [];
  for (let r=1; r<rows.length; r++){
    const row = rows[r] || [];
    const name = (row[nameCol] ?? '').toString().trim();
    const code = row[codeCol] ?? null;
    if (!name) continue;
    out.push({ code, name });
  }
  return out;
}

/* ---------- Автозагрузка при старте страницы ---------- */

(async () => {
  try {
    // подтягиваем запомненный шаблон (если был)
    const buf  = await getKV(KEY_BUF);
    const name = await getKV(KEY_NAME);
    if (buf) {
      templateBuf   = buf;                    // глобальные переменные у вас уже есть
      templateName  = name || '(запомненный)';
      storedInfo.textContent = 'Шаблон: ' + templateName;
    }

    // подхватываем кэш пиццерий и сразу показываем
    const cachedCities = await getCachedCities();
    if (cachedCities && cachedCities.length) {
      populateCities(cachedCities);
      window.citiesArray = cachedCities;     // если нужно ещё где-то
    }

    // включаем поиск по списку пиццерий
    hookCitySearch();

    // перерисуем редактор соответствий
    renderMapEditor();
  } catch(e) {
    setInfo('IndexedDB недоступен (шаблон/справочник не будут запоминаться)', true);
  }
})();

/* ---------- Кнопки запомнить/очистить шаблон ---------- */

document.getElementById('remember').onclick = async () => {
  const f = document.getElementById('tmpl').files[0];
  if (!f) { setInfo('Выберите .xlsx', true); return; }

  const buf = await f.arrayBuffer();
  await setKV(KEY_BUF, buf);
  await setKV(KEY_NAME, f.name);

  templateBuf  = buf;
  templateName = f.name;
  storedInfo.textContent = 'Шаблон: ' + f.name;
  setInfo('Шаблон запомнен');

  // если к этому моменту уже извлекли список городов — тоже сохраним
  if (Array.isArray(window.citiesArray) && window.citiesArray.length) {
    await setCachedCities(window.citiesArray);
    populateCities(window.citiesArray);
  }
};

document.getElementById('clearStored').onclick = async () => {
  await delKV(KEY_BUF);
  await delKV(KEY_NAME);
  templateBuf = null;
  templateName = null;
  storedInfo.textContent = '';
  setInfo('Шаблон забыли');
};

/* ---------- ДОПОЛНЕНИЕ: правка вашей readCatalogAndL1() ---------- */
/* ВНИМАНИЕ: ниже только функция. Вставьте её вместо вашей версии,
   чтобы при чтении шаблона мы также вытаскивали города и обновляли кэш. */

async function readCatalogAndL1(){
  const f   = document.getElementById('tmpl').files[0];
  const buf = f ? await f.arrayBuffer() : (templateBuf || await getKV(KEY_BUF));
  if (!buf) throw new Error('Нет шаблона');

  const wb = XLSX.read(buf, { type:'array', cellText:true, cellDates:true, cellNF:true });

  // --- Каталог (лист Order, колонка D начиная с 14 строки)
  const order = wb.Sheets['Order']; 
  if (!order) throw new Error('Нет листа Order');
  const ref = order['!ref'] || 'A1';
  const range = XLSX.utils.decode_range(ref);
  const list = [];
  for (let r=14; r<=range.e.r+1; r++){
    const addr = XLSX.utils.encode_cell({ c:3, r:r-1 }); // D
    const cell = order[addr];
    if (!cell) continue;
    const text = (cell.w!=null ? String(cell.w) : (cell.v!=null?String(cell.v):'')).trim();
    if (text) list.push({ r, text, norm: norm(text) });
  }
  catalog = list;

  // --- Пиццерии (лист L1 или аналог)
  const cities = extractCitiesFromWorkbook(wb);
  if (cities.length) {
    window.citiesArray = cities;
    populateCities(cities);
    setCachedCities(cities); // обновим кэш
  } else {
    // если не нашли — не падаем, просто оставляем как было
  }

  return buf; // понадобится для XlsxPopulate
}
</script>


